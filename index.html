<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ ËæûÂÖ∏</title>

<style>
:root{
  --bg:#0b0f14;
  --panel:#151822;
  --border:#252a36;
  --text:#e6e8ee;
  --muted:#9aa0aa;
  --muted2:#7b8192;

  --accent:#7b5cff;
  --accent2:#36d1dc;
  --accent3:#fb7185;
  --good:#34d399;
  --warn:#f59e0b;

  --radius:16px;
  --shadow: 0 18px 65px rgba(0,0,0,.45);
}

*{box-sizing:border-box}

body{
  background:
    radial-gradient(1200px 700px at 10% 10%, rgba(123,92,255,.22), transparent 55%),
    radial-gradient(900px 600px at 90% 15%, rgba(54,209,220,.16), transparent 55%),
    radial-gradient(900px 650px at 20% 90%, rgba(251,113,133,.12), transparent 55%),
    var(--bg);
  color:var(--text);
  font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",system-ui,sans-serif;
  margin:0;
  line-height:1.95;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  background: rgba(11,15,20,.72);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border-bottom:1px solid var(--border);
}

.topbar{
  max-width:1150px;
  margin:auto;
  padding:18px 18px 12px;
  display:flex;
  gap:18px;
  align-items:flex-start;
  justify-content:space-between;
  flex-wrap:wrap;
}

.brand{min-width:280px;}
.brand .t{
  font-size:20px;
  font-weight:800;
  letter-spacing:1.4px;
}
.brand .s{
  margin-top:6px;
  color:var(--muted);
  font-size:13px;
}
.brand .s span{color:var(--muted2);}

nav{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
}

.tabbtn{
  cursor:pointer;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color:var(--muted);
  padding:9px 12px;
  border-radius:999px;
  font-size:13px;
  user-select:none;
  transition: transform .08s ease, background .2s ease, color .2s ease, border-color .2s ease;
  box-shadow: var(--shadow);
}
.tabbtn:active{ transform: translateY(1px); }
.tabbtn.active{
  color:var(--text);
  border-color: rgba(54,209,220,.35);
  background: linear-gradient(90deg, rgba(123,92,255,.18), rgba(54,209,220,.15), rgba(251,113,133,.12));
}

.container{
  max-width:1150px;
  margin:auto;
  padding:34px 18px 90px;
}

.section{ display:none; }
.section.active{ display:block; }

.grid{
  display:grid;
  grid-template-columns: 1.15fr .85fr;
  gap:16px;
}
@media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

.panel{
  background: rgba(255,255,255,.06);
  border:1px solid var(--border);
  border-radius:22px;
  padding:16px;
  box-shadow: var(--shadow);
}

.panel h2{
  margin: 0 0 8px;
  font-size: 15px;
  letter-spacing:.6px;
}

.hint{
  color:var(--muted);
  font-size:13px;
  margin-top:0;
}

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}

.searchbox{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.searchbox input{
  flex: 1 1 320px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  color:var(--text);
  outline:none;
}
.searchbox input::placeholder{ color:var(--muted2); }

.toggle{
  display:flex;
  align-items:center;
  gap:8px;
  color:var(--muted);
  font-size:12px;
  user-select:none;
}
.toggle input{ transform: translateY(1px); }

select{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color: var(--text);
  outline:none;
}

.btn{
  cursor:pointer;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color:var(--text);
  padding:8px 10px;
  border-radius:12px;
  font-size:12px;
  user-select:none;
}
.btn.primary{
  border-color: rgba(54,209,220,.35);
  background: rgba(54,209,220,.12);
}
.btn.danger{
  border-color: rgba(251,113,133,.35);
  background: rgba(251,113,133,.10);
}
.btn.good{
  border-color: rgba(52,211,153,.35);
  background: rgba(52,211,153,.10);
}
.btn.warn{
  border-color: rgba(245,158,11,.35);
  background: rgba(245,158,11,.10);
}
.btn:disabled{
  opacity:.55;
  cursor:not-allowed;
}

.card{
  background: rgba(255,255,255,.07);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding:16px;
  margin-top:12px;
}
.card.exact{
  border-color: rgba(54,209,220,.38);
  box-shadow: 0 0 0 1px rgba(54,209,220,.08), var(--shadow);
}

.jp{
  font-size:22px;
  font-weight:900;
  letter-spacing:.5px;
  color:var(--accent2);
}
.hira{
  margin-top:6px;
  color:var(--muted);
  font-size:13px;
}
.mean{
  margin-top:8px;
  font-size:14px;
  color:var(--text);
  font-weight:600;
}

.badges{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
.badge{
  font-size:11px;
  border:1px solid var(--border);
  padding:3px 8px;
  border-radius:999px;
  color:var(--muted);
}
.badge.n5{ border-color: rgba(52,211,153,.35); color: rgba(52,211,153,.95); }
.badge.n4{ border-color: rgba(123,92,255,.45); color: rgba(123,92,255,.95); }
.badge.tag{ border-color: rgba(54,209,220,.35); color: rgba(54,209,220,.95); }
.badge.exact{ border-color: rgba(54,209,220,.55); color: rgba(54,209,220,.95); }
.badge.good{ border-color: rgba(52,211,153,.45); color: rgba(52,211,153,.95); }
.badge.bad{ border-color: rgba(251,113,133,.45); color: rgba(251,113,133,.95); }
.badge.warn{ border-color: rgba(245,158,11,.45); color: rgba(245,158,11,.95); }

.ex{
  margin-top:14px;
  padding-top:12px;
  border-top:1px solid rgba(255,255,255,.08);
}
.ex h4{
  margin:0 0 6px;
  font-size:13px;
  color:var(--accent2);
}
.exline{ margin:10px 0 10px; }
.exline b{ color:var(--text); }
.exline .k{ color:var(--accent2); }
.exp{
  color:var(--muted);
  font-size:13px;
  margin-top:6px;
}

.kanjigrid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(92px, 1fr));
  gap:12px;
  margin-top:12px;
}
.kanjiitem{
  background: rgba(255,255,255,.06);
  border:1px solid var(--border);
  border-radius: 16px;
  padding:12px 10px;
  text-align:center;
  cursor:pointer;
  transition: transform .12s ease, border-color .2s ease;
}
.kanjiitem:hover{
  transform: translateY(-1px);
  border-color: rgba(54,209,220,.28);
}
.kanjiitem .k{
  font-size:28px;
  font-weight:900;
  color:var(--accent2);
}
.kanjiitem .lvl{
  margin-top:6px;
  font-size:11px;
  color:var(--muted);
}
.kanjiitem .lvl b{ color:var(--text); }

.strokeBox{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  overflow:hidden;
  background: rgba(255,255,255,.04);
}
.strokeHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.strokeHead .t{ font-size:13px; color: var(--muted); }
.strokeBody{
  padding:12px;
}
.strokeBody svg{
  width:100%;
  height:auto;
  display:block;
}
.strokeNote{
  color: var(--muted);
  font-size:12px;
  margin-top:8px;
}

.bigKanji{
  font-size:86px;
  font-weight:900;
  letter-spacing:2px;
  text-align:center;
  color: var(--accent2);
  line-height:1.0;
  margin: 8px 0 6px;
}

hr.sep{
  border:none;
  border-top:1px solid rgba(255,255,255,.08);
  margin:14px 0;
}
.small{
  color:var(--muted);
  font-size:13px;
}
.small b{ color:var(--text); }

.footer{
  text-align:center;
  padding:40px 0 0;
  color:var(--muted);
  font-size:12px;
}

/* ===== Quiz (m√∫ltipla escolha) ===== */
.mcGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
}
@media (max-width: 820px){ .mcGrid{ grid-template-columns:1fr; } }

.mcBox{
  border:1px solid rgba(255,255,255,.08);
  border-radius:16px;
  padding:12px;
  background: rgba(255,255,255,.04);
}
.mcBox h3{
  margin:0 0 8px;
  font-size:13px;
  color:var(--muted);
  letter-spacing:.6px;
}

.choiceList{
  display:grid;
  gap:8px;
}
.choiceBtn{
  text-align:left;
  padding:10px 10px;
  border-radius:14px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color: var(--text);
  cursor:pointer;
  transition: transform .08s ease, border-color .2s ease;
}
.choiceBtn:hover{ transform: translateY(-1px); border-color: rgba(54,209,220,.25); }
.choiceBtn.correct{ border-color: rgba(52,211,153,.55); background: rgba(52,211,153,.12); }
.choiceBtn.wrong{ border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.10); }

.timerBarWrap{
  width:100%;
  height:10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  overflow:hidden;
  margin-top:10px;
}
.timerBar{
  height:100%;
  width:100%;
  background: linear-gradient(90deg, rgba(54,209,220,.65), rgba(123,92,255,.55), rgba(251,113,133,.45));
  transition: width .15s linear;
}
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="t">„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ ËæûÂÖ∏</div>
      <div class="s">
        „É¥„Ç°„É≥„Éë„Ç§„Ç¢ = vampiro <span>Ôºàobservador eternoÔºâ</span> / ÂÖ®Áü• = onisciente / ÂÖ®ËÉΩ = onipotente
      </div>
    </div>

    <nav>
      <div class="tabbtn active" id="tab-dic">üìñ Dicion√°rio</div>
      <div class="tabbtn" id="tab-kanji">üà∂ Kanji (N5‚ÜíN4)</div>
      <div class="tabbtn" id="tab-quiz">üéÆ Jogo</div>
      <div class="tabbtn" id="tab-about">‚ÑπÔ∏è Sobre</div>
    </nav>
  </div>
</header>

<div class="container">
  <!-- ====================== DICION√ÅRIO ====================== -->
  <section id="dic" class="section active">
    <div class="grid">
      <div class="panel">
        <div class="row">
          <div>
            <h2>Dicion√°rio (JP ‚Üí PT-BR)</h2>
            <p class="hint">Busca ranqueada (exato primeiro). Aceita kanji/kana/portugu√™s.</p>
          </div>

          <label class="toggle" title="Se existir uma entrada exata, mostra s√≥ ela.">
            <input type="checkbox" id="onlyExact" />
            s√≥ exato (quando houver)
          </label>
        </div>

        <div class="searchbox">
          <input id="q" type="text" placeholder="Buscar palavra..." autocomplete="off" />
          <div class="btn danger" id="btnClear">Limpar</div>
        </div>

        <div id="results"></div>
      </div>

      <div class="panel">
        <h2>Uso / M√©todo</h2>
        <p class="small">
          1) Busque a palavra ‚Üí confirme leitura e significado.<br>
          2) Leia as 3 frases (JP ‚Üí hiragana ‚Üí PT).<br>
          3) Depois v√° pro Jogo (m√∫ltipla escolha + timer).<br>
          4) O modo inteligente repete mais o que voc√™ erra.
        </p>
        <hr class="sep" />
        <div class="row">
          <div class="btn primary" id="btnRandom">Palavra aleat√≥ria</div>
          <div class="btn" id="btnGoKanji">Ver kanji</div>
          <div class="btn warn" id="btnGoQuiz">Ir pro jogo</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====================== KANJI LISTA ====================== -->
  <section id="kanji" class="section">
    <div class="grid">
      <div class="panel">
        <h2>Kanji ‚Äî N5 (ordem completa)</h2>
        <p class="hint">Clique num kanji: mostra leitura/significado + ordem dos tra√ßos.</p>
        <div class="kanjigrid" id="kanjigrid"></div>
      </div>

      <div class="panel">
        <h2>Detalhe do Kanji</h2>
        <p class="hint">Selecione um kanji na lista.</p>

        <div id="kanjiDetail" class="card" style="display:none;">
          <div class="jp" id="kdKanji"></div>
          <div class="hira" id="kdReadings"></div>
          <div class="mean" id="kdMean"></div>
          <div class="badges" id="kdBadges"></div>

          <div class="strokeBox">
            <div class="strokeHead">
              <div class="t">Ordem dos tra√ßos (Stroke order)</div>
              <div class="btn" id="kdReloadStroke">Recarregar</div>
            </div>
            <div class="strokeBody" id="kdStroke"></div>
            <div class="strokeNote">Carregado online (KanjiVG). Se falhar, Ctrl+F5 e tente de novo.</div>
          </div>

          <hr class="sep">
          <div class="row">
            <div class="btn primary" id="kdSearchDic">Buscar no Dicion√°rio</div>
            <div class="btn warn" id="kdGoQuiz">Treinar no Jogo</div>
          </div>
        </div>

        <div id="kanjiDetailEmpty" class="card">
          <div class="mean" style="color:var(--muted);">Clique em um kanji para ver detalhes aqui.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====================== QUIZ (JOGO) ====================== -->
  <section id="quiz" class="section">
    <div class="grid">
      <div class="panel">
        <div class="row">
          <div>
            <h2>Jogo ‚Äî m√∫ltipla escolha + timer</h2>
            <p class="hint">Voc√™ escolhe: (1) conjunto de leituras (2) conjunto de significados. A√≠ ele corrige e avan√ßa.</p>
          </div>
          <div class="row">
            <label class="toggle" title="O modo inteligente repete mais o que voc√™ erra.">
              <input type="checkbox" id="quizSmart" checked />
              modo inteligente
            </label>
            <label class="toggle" title="Somente N5 por enquanto (voc√™ pode expandir depois).">
              <input type="checkbox" id="quizOnlyN5" checked />
              somente N5
            </label>
          </div>
        </div>

        <div class="card">
          <div class="row" style="align-items:flex-end;">
            <div style="flex:1;">
              <div class="bigKanji" id="quizKanji">‰∏Ä</div>
              <div class="badges" style="justify-content:center;">
                <span class="badge" id="quizScore">Acertos: 0 ¬∑ Erros: 0 ¬∑ Streak: 0</span>
                <span class="badge tag" id="quizMode">Modo: N5</span>
                <span class="badge warn" id="quizTimerText">‚è±Ô∏è 12s</span>
              </div>
              <div class="timerBarWrap" title="Timer">
                <div class="timerBar" id="timerBar"></div>
              </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <div class="small" style="margin-top:6px;">Tempo</div>
              <select id="quizTime">
                <option value="8">8s</option>
                <option value="12" selected>12s</option>
                <option value="18">18s</option>
                <option value="25">25s</option>
              </select>
              <div class="btn good" id="quizStart">Start</div>
              <div class="btn" id="quizPause">Pausar</div>
              <div class="btn warn" id="quizNext">Pr√≥ximo</div>
              <div class="btn danger" id="quizReset">Zerar</div>
            </div>
          </div>

          <hr class="sep">

          <div class="mcGrid">
            <div class="mcBox">
              <h3>Leituras (escolha 1)</h3>
              <div class="choiceList" id="readingChoices"></div>
            </div>

            <div class="mcBox">
              <h3>Significados (PT-BR) (escolha 1)</h3>
              <div class="choiceList" id="meaningChoices"></div>
            </div>
          </div>

          <div id="quizFeedback" class="card" style="display:none;">
            <div class="mean" id="quizFeedbackTitle"></div>
            <div class="hira" id="quizFeedbackDetail"></div>

            <div class="strokeBox" style="margin-top:12px;">
              <div class="strokeHead">
                <div class="t">Ordem dos tra√ßos (Stroke order)</div>
                <div class="btn" id="quizReloadStroke">Recarregar</div>
              </div>
              <div class="strokeBody" id="quizStroke"></div>
              <div class="strokeNote">Carregado online (KanjiVG). Se falhar, recarregue.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Ranking + Estat√≠sticas (local)</h2>
        <p class="hint">Isso salva no seu navegador (localStorage). N√£o precisa de login.</p>

        <div class="card">
          <div class="mean">üèÜ Melhores marcas</div>
          <div class="small" id="bestStats">‚Äî</div>
          <hr class="sep">
          <div class="mean">üìä Top kanji mais errados</div>
          <div class="small" id="worstKanjis">‚Äî</div>
          <hr class="sep">
          <div class="mean">‚öôÔ∏è Regras do acerto</div>
          <div class="small">
            ‚Ä¢ Voc√™ precisa acertar 2/2: leituras + significados.<br>
            ‚Ä¢ As op√ß√µes mostram o conjunto completo (ex.: ‚Äú„ÅÑ„Å° / „Å≤„Å®‚Äù).<br>
            ‚Ä¢ O modo inteligente puxa mais os que voc√™ errou (√≥timo pra fixar).
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ====================== SOBRE ====================== -->
  <section id="about" class="section">
    <div class="panel">
      <h2>Sobre ‚Äî „É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ</h2>
      <p class="small">
        Este dicion√°rio + jogo fazem parte do projeto <b>„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ</b>.<br>
        Meta: dominar japon√™s com m√©todo ‚Äî <b>kanji / leitura / significado / repeti√ß√£o inteligente</b>.
      </p>
    </div>
  </section>

  <div class="footer">„É¥„Ç°„É≥„Éë„Ç§„Ç¢ÂÖ®Áü•ÂÖ®ËÉΩ ¬© 2025 ‚Äî ËæûÂÖ∏ / Kanji / Jogo</div>
</div>

<script>
/* =========================
   DICION√ÅRIO (opcional)
   ========================= */
const WORDS = [
  {
    jp:"È£ü„Åπ„Çã", hira:"„Åü„Åπ„Çã", tipo:"verbo (ichidan)", mean:"comer", tags:["N5","cotidiano"],
    examples:[
      { jp:"Êúù„Åî„ÅØ„Çì„ÇíÈ£ü„Åπ„Åæ„Åó„Åü„ÄÇ", hira:"„ÅÇ„Åï„Åî„ÅØ„Çì „Çí „Åü„Åπ„Åæ„Åó„Åü„ÄÇ", pt:"Comi caf√© da manh√£.", exp:"Êúù„Åî„ÅØ„Çì = caf√© da manh√£; „Çí = objeto; „Äú„Åæ„Åó„Åü = passado polido." },
      { jp:"‰Ωï„ÇíÈ£ü„Åπ„Åü„ÅÑ„Åß„Åô„ÅãÔºü", hira:"„Å™„Å´ „Çí „Åü„Åπ„Åü„ÅÑ „Åß„Åô „ÅãÔºü", pt:"O que voc√™ quer comer?", exp:"„Äú„Åü„ÅÑ = querer; „Åß„Åô„Åã = pergunta educada." },
      { jp:"Âèã„Å†„Å°„Å®Êòº„Åî„ÅØ„Çì„ÇíÈ£ü„Åπ„Å´Ë°å„Åç„Åæ„Åô„ÄÇ", hira:"„Å®„ÇÇ„Å†„Å° „Å® „Å≤„Çã„Åî„ÅØ„Çì „Çí „Åü„Åπ „Å´ „ÅÑ„Åç„Åæ„Åô„ÄÇ", pt:"Vou almo√ßar com um amigo.", exp:"V„Åæ„Åô-stem + „Å´Ë°å„Åè = ir para fazer algo (È£ü„Åπ„Åæ„Åô‚ÜíÈ£ü„Åπ)." }
    ]
  }
];

/* =========================
   KANJI N5 (seus 80)
   ========================= */
const KANJI_ORDER_N5 = [
  "‰∏Ä","‰∏É","‰∏á","‰∏â","‰∏ä","‰∏ã","‰∏≠","‰πù","‰∫å","‰∫î","‰∫∫","‰ªä","‰ºë","‰Ωï","ÂÖà","ÂÖ•","ÂÖ´","ÂÖ≠","ÂÜÜ","Âá∫","ÂàÜ","Ââç","Âåó","ÂçÅ","ÂçÉ","Âçà","Âçä","Âçó","Âèã","Âè≥","Âêç","Âõõ","ÂõΩ","Âúü","Â§ñ","Â§ß","Â§©","Â•≥","Â≠ê","Â≠¶","Â∞è","Â±±","Â∑ù","Â∑¶","Âπ¥","Âæå","Êó•","ÊôÇ","Êõ∏","Êúà","Êú®","Êú¨","Êù•","Êù±","Ê†°","ÊØç","ÊØé","Ê∞ó","Ê∞¥","ÁÅ´","Áà∂","Áîü","Áî∑","ÁôΩ","Áôæ","ËÅû","Ë°å","Ë•ø","Ë¶ã","Ë©±","Ë™û","Ë™≠","Ëªä","Èáë","Èï∑","Èñì","Èõ®","Èõª","È£ü","È´ò"
];

/* Leituras aceitas (hiragana/katakana). Significados (palavras-chave PT) */
const KANJI_INFO = {
  "‰∏Ä":{lvl:"N5", readings:["„ÅÑ„Å°","„Å≤„Å®"], meanings:["um","1"]},
  "‰∏É":{lvl:"N5", readings:["„Åó„Å°","„Å™„Å™"], meanings:["sete","7"]},
  "‰∏á":{lvl:"N5", readings:["„Åæ„Çì"], meanings:["dez mil","10000","10 mil"]},
  "‰∏â":{lvl:"N5", readings:["„Åï„Çì","„Åø„Å£"], meanings:["tr√™s","3"]},
  "‰∏ä":{lvl:"N5", readings:["„Åò„Çá„ÅÜ","„ÅÜ„Åà","„ÅÇ"], meanings:["cima","acima","superior"]},
  "‰∏ã":{lvl:"N5", readings:["„Åã","„Åó„Åü","„Åï"], meanings:["baixo","abaixo","inferior"]},
  "‰∏≠":{lvl:"N5", readings:["„Å°„ÇÖ„ÅÜ","„Å™„Åã"], meanings:["meio","dentro","centro"]},
  "‰πù":{lvl:"N5", readings:["„Åç„ÇÖ„ÅÜ","„Åì„Åì„ÅÆ"], meanings:["nove","9"]},
  "‰∫å":{lvl:"N5", readings:["„Å´","„Åµ„Åü"], meanings:["dois","2"]},
  "‰∫î":{lvl:"N5", readings:["„Åî","„ÅÑ„Å§"], meanings:["cinco","5"]},
  "‰∫∫":{lvl:"N5", readings:["„Åò„Çì","„Å´„Çì","„Å≤„Å®"], meanings:["pessoa","gente","humano"]},
  "‰ªä":{lvl:"N5", readings:["„Åì„Çì","„ÅÑ„Åæ"], meanings:["agora","atualmente"]},
  "‰ºë":{lvl:"N5", readings:["„Åç„ÇÖ„ÅÜ","„ÇÑ„Åô"], meanings:["descansar","folga","feriado","pausa"]},
  "‰Ωï":{lvl:"N5", readings:["„Å™„Çì","„Å™„Å´"], meanings:["o que","qual"]},
  "ÂÖà":{lvl:"N5", readings:["„Åõ„Çì","„Åï„Åç"], meanings:["antes","anterior","frente","ponta"]},
  "ÂÖ•":{lvl:"N5", readings:["„Å´„ÇÖ„ÅÜ","„ÅÑ"], meanings:["entrar","entrada","inserir"]},
  "ÂÖ´":{lvl:"N5", readings:["„ÅØ„Å°","„ÇÑ"], meanings:["oito","8"]},
  "ÂÖ≠":{lvl:"N5", readings:["„Çç„Åè","„ÇÄ"], meanings:["seis","6"]},
  "ÂÜÜ":{lvl:"N5", readings:["„Åà„Çì"], meanings:["iene","yen","c√≠rculo"]},
  "Âá∫":{lvl:"N5", readings:["„Åó„ÇÖ„Å§","„Åß","„Å†"], meanings:["sair","sa√≠da","aparecer","tirar"]},
  "ÂàÜ":{lvl:"N5", readings:["„Å∂„Çì","„Åµ„Çì","„Çè"], meanings:["minuto","parte","entender"]},
  "Ââç":{lvl:"N5", readings:["„Åú„Çì","„Åæ„Åà"], meanings:["antes","frente","anterior"]},
  "Âåó":{lvl:"N5", readings:["„Åª„Åè","„Åç„Åü"], meanings:["norte"]},
  "ÂçÅ":{lvl:"N5", readings:["„Åò„ÇÖ„ÅÜ","„Å®„Åä"], meanings:["dez","10"]},
  "ÂçÉ":{lvl:"N5", readings:["„Åõ„Çì","„Å°"], meanings:["mil","1000"]},
  "Âçà":{lvl:"N5", readings:["„Åî"], meanings:["meio-dia","am/pm"]},
  "Âçä":{lvl:"N5", readings:["„ÅØ„Çì"], meanings:["metade","meia"]},
  "Âçó":{lvl:"N5", readings:["„Å™„Çì","„Åø„Å™„Åø"], meanings:["sul"]},
  "Âèã":{lvl:"N5", readings:["„ÇÜ„ÅÜ","„Å®„ÇÇ"], meanings:["amigo"]},
  "Âè≥":{lvl:"N5", readings:["„ÅÜ","„Åø„Åé"], meanings:["direita"]},
  "Âêç":{lvl:"N5", readings:["„ÇÅ„ÅÑ","„Å™"], meanings:["nome","fama"]},
  "Âõõ":{lvl:"N5", readings:["„Åó","„Çà„Çì","„Çà"], meanings:["quatro","4"]},
  "ÂõΩ":{lvl:"N5", readings:["„Åì„Åè","„Åè„Å´"], meanings:["pa√≠s","na√ß√£o"]},
  "Âúü":{lvl:"N5", readings:["„Å©","„Å§„Å°"], meanings:["terra","solo","s√°bado"]},
  "Â§ñ":{lvl:"N5", readings:["„Åå„ÅÑ","„Åù„Å®","„ÅØ„Åö"], meanings:["fora","exterior"]},
  "Â§ß":{lvl:"N5", readings:["„Å†„ÅÑ","„Åä„Åä"], meanings:["grande"]},
  "Â§©":{lvl:"N5", readings:["„Å¶„Çì","„ÅÇ„Åæ"], meanings:["c√©u"]},
  "Â•≥":{lvl:"N5", readings:["„Åò„Çá","„Åä„Çì„Å™"], meanings:["mulher","feminino"]},
  "Â≠ê":{lvl:"N5", readings:["„Åó","„Åì"], meanings:["crian√ßa","filho"]},
  "Â≠¶":{lvl:"N5", readings:["„Åå„Åè","„Åæ„Å™"], meanings:["estudo","aprender","escola"]},
  "Â∞è":{lvl:"N5", readings:["„Åó„Çá„ÅÜ","„Å°„ÅÑ"], meanings:["pequeno"]},
  "Â±±":{lvl:"N5", readings:["„Åï„Çì","„ÇÑ„Åæ"], meanings:["montanha"]},
  "Â∑ù":{lvl:"N5", readings:["„Åõ„Çì","„Åã„Çè"], meanings:["rio"]},
  "Â∑¶":{lvl:"N5", readings:["„Åï","„Å≤„Å†„Çä"], meanings:["esquerda"]},
  "Âπ¥":{lvl:"N5", readings:["„Å≠„Çì","„Å®„Åó"], meanings:["ano"]},
  "Âæå":{lvl:"N5", readings:["„Åî","„ÅÆ„Å°","„ÅÜ„Åó"], meanings:["depois","atr√°s"]},
  "Êó•":{lvl:"N5", readings:["„Å´„Å°","„Åò„Å§","„Å≤"], meanings:["dia","sol"]},
  "ÊôÇ":{lvl:"N5", readings:["„Åò","„Å®„Åç"], meanings:["hora","tempo"]},
  "Êõ∏":{lvl:"N5", readings:["„Åó„Çá","„Åã"], meanings:["escrever","livro"]},
  "Êúà":{lvl:"N5", readings:["„Åí„Å§","„Åå„Å§","„Å§„Åç"], meanings:["m√™s","lua"]},
  "Êú®":{lvl:"N5", readings:["„ÇÇ„Åè","„Åº„Åè","„Åç"], meanings:["√°rvore","madeira"]},
  "Êú¨":{lvl:"N5", readings:["„Åª„Çì","„ÇÇ„Å®"], meanings:["livro","origem"]},
  "Êù•":{lvl:"N5", readings:["„Çâ„ÅÑ","„Åè","„Åì"], meanings:["vir","pr√≥ximo"]},
  "Êù±":{lvl:"N5", readings:["„Å®„ÅÜ","„Å≤„Åå„Åó"], meanings:["leste"]},
  "Ê†°":{lvl:"N5", readings:["„Åì„ÅÜ"], meanings:["escola"]},
  "ÊØç":{lvl:"N5", readings:["„Åº","„ÅØ„ÅØ"], meanings:["m√£e"]},
  "ÊØé":{lvl:"N5", readings:["„Åæ„ÅÑ"], meanings:["todo","cada"]},
  "Ê∞ó":{lvl:"N5", readings:["„Åç","„Åë"], meanings:["energia","ar","esp√≠rito","clima","humor"]},
  "Ê∞¥":{lvl:"N5", readings:["„Åô„ÅÑ","„Åø„Åö"], meanings:["√°gua","quarta"]},
  "ÁÅ´":{lvl:"N5", readings:["„Åã","„Å≤"], meanings:["fogo","ter√ßa"]},
  "Áà∂":{lvl:"N5", readings:["„Åµ","„Å°„Å°"], meanings:["pai"]},
  "Áîü":{lvl:"N5", readings:["„Åõ„ÅÑ","„Åó„Çá„ÅÜ","„ÅÑ","„ÅÜ","„Å™„Åæ"], meanings:["vida","nascer","cru","aluno"]},
  "Áî∑":{lvl:"N5", readings:["„Å†„Çì","„Åä„Å®„Åì"], meanings:["homem","masculino"]},
  "ÁôΩ":{lvl:"N5", readings:["„ÅØ„Åè","„Åó„Çç"], meanings:["branco"]},
  "Áôæ":{lvl:"N5", readings:["„Å≤„ÇÉ„Åè"], meanings:["cem","100"]},
  "ËÅû":{lvl:"N5", readings:["„Å∂„Çì","„ÇÇ„Çì","„Åç"], meanings:["ouvir","perguntar"]},
  "Ë°å":{lvl:"N5", readings:["„Åì„ÅÜ","„Åé„Çá„ÅÜ","„ÅÑ","„ÇÜ"], meanings:["ir","linha","fazer"]},
  "Ë•ø":{lvl:"N5", readings:["„Åõ„ÅÑ","„Å´„Åó"], meanings:["oeste"]},
  "Ë¶ã":{lvl:"N5", readings:["„Åë„Çì","„Åø"], meanings:["ver","olhar","assistir"]},
  "Ë©±":{lvl:"N5", readings:["„Çè","„ÅØ„Å™"], meanings:["falar","conversa","hist√≥ria"]},
  "Ë™û":{lvl:"N5", readings:["„Åî","„Åã„Åü"], meanings:["l√≠ngua","idioma","palavra"]},
  "Ë™≠":{lvl:"N5", readings:["„Å©„Åè","„Çà"], meanings:["ler"]},
  "Ëªä":{lvl:"N5", readings:["„Åó„ÇÉ","„Åè„Çã„Åæ"], meanings:["carro","ve√≠culo"]},
  "Èáë":{lvl:"N5", readings:["„Åç„Çì","„Åã„Å≠"], meanings:["dinheiro","ouro","sexta"]},
  "Èï∑":{lvl:"N5", readings:["„Å°„Çá„ÅÜ","„Å™„Åå"], meanings:["longo","chefe"]},
  "Èñì":{lvl:"N5", readings:["„Åã„Çì","„Åë„Çì","„ÅÇ„ÅÑ„Å†","„Åæ"], meanings:["entre","intervalo","tempo"]},
  "Èõ®":{lvl:"N5", readings:["„ÅÜ","„ÅÇ„ÇÅ"], meanings:["chuva"]},
  "Èõª":{lvl:"N5", readings:["„Åß„Çì"], meanings:["eletricidade"]},
  "È£ü":{lvl:"N5", readings:["„Åó„Çá„Åè","„Åü"], meanings:["comer","comida"]},
  "È´ò":{lvl:"N5", readings:["„Åì„ÅÜ","„Åü„Åã"], meanings:["alto","caro"]}
};

/* =========================
   TABS
   ========================= */
const sections = {
  dic: document.getElementById("dic"),
  kanji: document.getElementById("kanji"),
  quiz: document.getElementById("quiz"),
  about: document.getElementById("about"),
};
const tabs = {
  dic: document.getElementById("tab-dic"),
  kanji: document.getElementById("tab-kanji"),
  quiz: document.getElementById("tab-quiz"),
  about: document.getElementById("tab-about"),
};
function openTab(id){
  Object.values(sections).forEach(s=>s.classList.remove("active"));
  Object.values(tabs).forEach(t=>t.classList.remove("active"));
  sections[id].classList.add("active");
  tabs[id].classList.add("active");
  if(id==="kanji") renderKanjiGrid();
}

/* =========================
   UTIL
   ========================= */
function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function normalize(s){
  return (s ?? "")
    .toString().trim().toLowerCase()
    .replace(/[\s„ÄÄ]+/g, "")
    .replace(/[„ÄÇ„ÄÅÔºå,.!?ÔºÅÔºü„Äå„Äç„Äé„ÄèÔºàÔºâ()„Äê„Äë\[\]""'‚Äô]/g, "");
}

/* =========================
   DICION√ÅRIO: busca ranqueada
   ========================= */
const q = document.getElementById("q");
const results = document.getElementById("results");
const onlyExactEl = document.getElementById("onlyExact");

function isExactHeadword(word, qNorm){
  const jp = normalize(word.jp);
  const hira = normalize(word.hira);
  const mean = normalize(word.mean);
  return (jp && jp === qNorm) || (hira && hira === qNorm) || (mean && mean === qNorm);
}
function scoreWord(word, qNorm){
  const jp = normalize(word.jp);
  const hira = normalize(word.hira);
  const mean = normalize(word.mean);

  if(jp === qNorm) return 1000;
  if(hira === qNorm) return 950;
  if(mean === qNorm) return 900;

  if(jp.startsWith(qNorm)) return 780;
  if(hira.startsWith(qNorm)) return 740;
  if(mean.startsWith(qNorm)) return 700;

  if(jp.includes(qNorm)) return 520;
  if(hira.includes(qNorm)) return 500;
  if(mean.includes(qNorm)) return 480;

  const ex = (word.examples || []);
  let best = 0;
  for(const e of ex){
    const ejp = normalize(e.jp);
    const ehira = normalize(e.hira);
    const ept = normalize(e.pt);
    const eexp = normalize(e.exp);
    if(ejp === qNorm || ehira === qNorm || ept === qNorm) best = Math.max(best, 360);
    else if(ejp.includes(qNorm) || ehira.includes(qNorm) || ept.includes(qNorm) || eexp.includes(qNorm)) best = Math.max(best, 220);
  }
  const tags = (word.tags || []).map(normalize);
  const tipo = normalize(word.tipo);
  if(tags.some(t => t.includes(qNorm))) best = Math.max(best, 180);
  if(tipo.includes(qNorm)) best = Math.max(best, 160);

  return best;
}
function renderExamples(examples){
  if(!examples || !examples.length){
    return `<div class="ex"><h4>Exemplos</h4><div class="exp">Sem exemplos ainda.</div></div>`;
  }
  return examples.slice(0,3).map((e, idx)=>`
    <div class="ex">
      <h4>Exemplo ${idx+1}</h4>
      <div class="exline">
        <b>${escapeHtml(e.jp || "")}</b><br>
        <span class="k">${escapeHtml(e.hira || "")}</span><br>
        ${escapeHtml(e.pt || "")}
      </div>
      <div class="exp"><b>Explica√ß√£o (PT-BR):</b> ${escapeHtml(e.exp || "")}</div>
    </div>
  `).join("");
}
function renderResults(raw){
  const query = (raw ?? q.value).trim();
  results.innerHTML = "";
  if(!query){
    results.innerHTML = `<div class="card"><div class="mean" style="color:var(--muted)">Digite algo para buscar.</div></div>`;
    return;
  }

  const qNorm = normalize(query);
  const ranked = WORDS
    .map(w => ({ w, s: scoreWord(w, qNorm) }))
    .filter(x => x.s > 0)
    .sort((a,b)=> b.s - a.s);

  if(!ranked.length){
    results.innerHTML = `<div class="card"><div class="mean">Nenhum resultado para ‚Äú${escapeHtml(query)}‚Äù.</div></div>`;
    return;
  }

  const exact = ranked.filter(x => isExactHeadword(x.w, qNorm));
  const nonExact = ranked.filter(x => !isExactHeadword(x.w, qNorm));
  const onlyExact = !!onlyExactEl.checked;
  const finalList = exact.length ? (onlyExact ? exact : [...exact, ...nonExact]) : ranked;

  const header = document.createElement("div");
  header.className = "card";
  header.innerHTML = `
    <div class="mean">Busca: <b>${escapeHtml(query)}</b> ‚Äî resultados: <b>${finalList.length}</b>
      ${exact.length ? `&nbsp;&nbsp;<span class="badge exact">exato encontrado</span>` : ``}
    </div>`;
  results.appendChild(header);

  const LIMIT = 10;
  finalList.slice(0, LIMIT).forEach(item=>{
    const w = item.w;
    const isExact = isExactHeadword(w, qNorm);

    const badges = (w.tags||[]).map(t=>{
      const low = (t||"").toString().toLowerCase();
      if(low==="n5") return `<span class="badge n5">N5</span>`;
      if(low==="n4") return `<span class="badge n4">N4</span>`;
      return `<span class="badge tag">${escapeHtml(t)}</span>`;
    }).join("");

    const card = document.createElement("div");
    card.className = "card" + (isExact ? " exact" : "");
    card.innerHTML = `
      <div class="jp">${escapeHtml(w.jp)}</div>
      <div class="hira">${escapeHtml(w.hira || "‚Äî")}</div>
      <div class="mean">(${escapeHtml(w.tipo || "‚Äî")}) ‚Äî ${escapeHtml(w.mean || "‚Äî")}</div>
      <div class="badges">${badges}</div>
      ${renderExamples(w.examples || [])}
    `;
    results.appendChild(card);
  });
}

let debounceTimer=null;
q.addEventListener("input", ()=>{
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(()=>renderResults(q.value),80);
});
onlyExactEl.addEventListener("change", ()=> renderResults(q.value));

document.getElementById("btnClear").addEventListener("click", ()=>{
  q.value=""; renderResults(""); q.focus();
});
document.getElementById("btnRandom").addEventListener("click", ()=>{
  if(!WORDS.length) return;
  const pick = WORDS[Math.floor(Math.random()*WORDS.length)];
  q.value = pick.jp; renderResults(pick.jp);
});
document.getElementById("btnGoKanji").addEventListener("click", ()=> openTab("kanji"));
document.getElementById("btnGoQuiz").addEventListener("click", ()=> openTab("quiz"));

/* =========================
   Stroke order (KanjiVG)
   ========================= */
function codepointHex5(ch){
  const hex = ch.codePointAt(0).toString(16);
  return hex.padStart(5,"0");
}
async function loadKanjiStrokeSVG(kanji, targetEl){
  const hex = codepointHex5(kanji);
  const url = `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}.svg`;
  targetEl.innerHTML = `<div class="small">Carregando stroke order...</div>`;
  try{
    const res = await fetch(url, {cache:"force-cache"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const svgText = await res.text();
    const cleaned = svgText
      .replace(/width="[^"]*"/g,'')
      .replace(/height="[^"]*"/g,'')
      .replace(/<\?xml[^>]*\?>/g,'');
    targetEl.innerHTML = cleaned;
  }catch(err){
    targetEl.innerHTML = `<div class="small">Falha ao carregar agora. Clique em ‚ÄúRecarregar‚Äù ou use Ctrl+F5.</div>`;
  }
}

/* =========================
   Kanji tab
   ========================= */
const kanjigrid = document.getElementById("kanjigrid");
const kdBox = document.getElementById("kanjiDetail");
const kdEmpty = document.getElementById("kanjiDetailEmpty");
const kdKanji = document.getElementById("kdKanji");
const kdReadings = document.getElementById("kdReadings");
const kdMean = document.getElementById("kdMean");
const kdBadges = document.getElementById("kdBadges");
const kdStroke = document.getElementById("kdStroke");
let currentKanjiSelected = null;

function renderKanjiGrid(){
  kanjigrid.innerHTML = "";
  KANJI_ORDER_N5.forEach(k=>{
    const div = document.createElement("div");
    div.className="kanjiitem";
    div.innerHTML = `<div class="k">${escapeHtml(k)}</div><div class="lvl"><b>N5</b> „Éª clique</div>`;
    div.addEventListener("click", ()=> showKanjiDetail(k));
    kanjigrid.appendChild(div);
  });
}
function showKanjiDetail(k){
  currentKanjiSelected = k;
  const info = KANJI_INFO[k];

  kdEmpty.style.display="none";
  kdBox.style.display="block";

  kdKanji.textContent = k;
  if(info){
    kdReadings.textContent = `Leituras: ${info.readings.join(" / ")}`;
    kdMean.textContent = `Significado (PT): ${info.meanings.join(" / ")}`;
    kdBadges.innerHTML = `<span class="badge n5">N5</span><span class="badge tag">kanji</span>`;
  }else{
    kdReadings.textContent = "Leituras: (n√£o cadastrado ainda)";
    kdMean.textContent = "Significado: (n√£o cadastrado ainda)";
    kdBadges.innerHTML = `<span class="badge tag">sem ficha</span>`;
  }
  loadKanjiStrokeSVG(k, kdStroke);
}
document.getElementById("kdReloadStroke").addEventListener("click", ()=>{
  if(currentKanjiSelected) loadKanjiStrokeSVG(currentKanjiSelected, kdStroke);
});
document.getElementById("kdSearchDic").addEventListener("click", ()=>{
  if(!currentKanjiSelected) return;
  openTab("dic");
  q.value = currentKanjiSelected;
  renderResults(currentKanjiSelected);
  window.scrollTo({top:0, behavior:"smooth"});
});
document.getElementById("kdGoQuiz").addEventListener("click", ()=>{
  if(!currentKanjiSelected) return;
  openTab("quiz");
  setQuizKanji(currentKanjiSelected, true);
});

/* =========================
   QUIZ: m√∫ltipla escolha + timer + ranking
   ========================= */
const quizOnlyN5 = document.getElementById("quizOnlyN5");
const quizSmart = document.getElementById("quizSmart");
const quizKanji = document.getElementById("quizKanji");
const quizScoreEl = document.getElementById("quizScore");
const quizModeEl = document.getElementById("quizMode");
const quizTimerText = document.getElementById("quizTimerText");
const timerBar = document.getElementById("timerBar");

const quizTime = document.getElementById("quizTime");
const quizStart = document.getElementById("quizStart");
const quizPause = document.getElementById("quizPause");
const quizNext = document.getElementById("quizNext");
const quizReset = document.getElementById("quizReset");

const readingChoices = document.getElementById("readingChoices");
const meaningChoices = document.getElementById("meaningChoices");

const quizFeedback = document.getElementById("quizFeedback");
const quizFeedbackTitle = document.getElementById("quizFeedbackTitle");
const quizFeedbackDetail = document.getElementById("quizFeedbackDetail");
const quizStroke = document.getElementById("quizStroke");
document.getElementById("quizReloadStroke").addEventListener("click", ()=>{
  loadKanjiStrokeSVG(quizState.current, quizStroke);
});

const bestStatsEl = document.getElementById("bestStats");
const worstKanjisEl = document.getElementById("worstKanjis");

const LS_KEY = "vampire_znzn_quiz_stats_v1";

function loadStats(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}
function saveStats(data){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }catch(e){}
}
function defaultStats(){
  return {
    bestStreak: 0,
    bestAccuracy: 0,   // 0..1
    bestScore: 0,      // acertos - erros
    totalCorrect: 0,
    totalWrong: 0,
    perKanji: {}       // { "Êó•": {c:0,w:0} }
  };
}
let stats = loadStats() || defaultStats();

let quizState = {
  current: "‰∏Ä",
  correct: 0,
  wrong: 0,
  streak: 0,
  running: false,
  answeredReading: false,
  answeredMeaning: false,
  chosenReading: null,
  chosenMeaning: null,
  timeLeftMs: 12000,
  timeTotalMs: 12000,
  timerId: null
};

function getPool(){
  // por enquanto: N5 completo
  return quizOnlyN5.checked ? KANJI_ORDER_N5 : KANJI_ORDER_N5;
}

function updateModeUI(){
  quizModeEl.textContent = quizOnlyN5.checked ? "Modo: N5" : "Modo: N5+N4";
}
quizOnlyN5.addEventListener("change", ()=>{
  updateModeUI();
  nextQuestion(true);
});

function ensurePerKanji(k){
  if(!stats.perKanji[k]) stats.perKanji[k] = {c:0,w:0};
}

function weightedPick(pool){
  // modo inteligente: mais peso pra quem voc√™ erra
  // peso = 1 + w*2 - c*0.35 (m√≠nimo 0.2)
  // + leve boost para "n√£o treinado"
  let total = 0;
  const weights = pool.map(k=>{
    ensurePerKanji(k);
    const {c,w} = stats.perKanji[k];
    const unseenBoost = (c+w===0) ? 0.8 : 0;
    const weight = Math.max(0.2, 1 + w*2 - c*0.35 + unseenBoost);
    total += weight;
    return weight;
  });

  let r = Math.random() * total;
  for(let i=0;i<pool.length;i++){
    r -= weights[i];
    if(r <= 0) return pool[i];
  }
  return pool[pool.length-1];
}

function pickKanji(){
  const pool = getPool();
  if(!quizSmart.checked) return pool[Math.floor(Math.random()*pool.length)];
  return weightedPick(pool);
}

function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function uniqueByText(options){
  const seen = new Set();
  const out = [];
  for(const o of options){
    const key = o.text;
    if(seen.has(key)) continue;
    seen.add(key);
    out.push(o);
  }
  return out;
}

function makeReadingText(k){
  const info = KANJI_INFO[k];
  if(!info) return "‚Äî";
  return info.readings.join(" / ");
}
function makeMeaningText(k){
  const info = KANJI_INFO[k];
  if(!info) return "‚Äî";
  return info.meanings.join(" / ");
}

function buildChoices(kind, correctKanji){
  // kind: "reading" | "meaning"
  const pool = getPool().filter(k => k !== correctKanji);
  const distractors = shuffle(pool).slice(0, 6); // pega mais e depois filtra duplicados

  const correctText = (kind==="reading") ? makeReadingText(correctKanji) : makeMeaningText(correctKanji);
  const correct = { kanji: correctKanji, text: correctText, correct: true };

  const opts = [correct, ...distractors.map(k=>{
    const text = (kind==="reading") ? makeReadingText(k) : makeMeaningText(k);
    return { kanji:k, text, correct:false };
  })];

  // remove duplicados e garante 4 op√ß√µes
  const cleaned = uniqueByText(opts).slice(0,4);

  // Se por acaso faltou, completa com aleat√≥rios sem repetir texto
  if(cleaned.length < 4){
    const more = shuffle(pool);
    for(const k of more){
      const text = (kind==="reading") ? makeReadingText(k) : makeMeaningText(k);
      if(cleaned.some(o=>o.text===text)) continue;
      cleaned.push({kanji:k, text, correct:false});
      if(cleaned.length===4) break;
    }
  }

  // garante que o correto est√° dentro
  if(!cleaned.some(o=>o.correct)){
    cleaned[0] = correct;
  }
  return shuffle(cleaned);
}

function resetChoicesUI(){
  readingChoices.innerHTML = "";
  meaningChoices.innerHTML = "";
  quizState.answeredReading = false;
  quizState.answeredMeaning = false;
  quizState.chosenReading = null;
  quizState.chosenMeaning = null;
}

function showFeedback(scored, isCorrectAll){
  quizFeedback.style.display = "block";
  const k = quizState.current;
  const info = KANJI_INFO[k];
  const r = info ? info.readings.join(" / ") : "‚Äî";
  const m = info ? info.meanings.join(" / ") : "‚Äî";

  if(scored){
    quizFeedbackTitle.innerHTML = isCorrectAll
      ? `‚úÖ <b>Acertou!</b> (2/2)`
      : `‚ùå <b>Errou.</b>`;
  }else{
    quizFeedbackTitle.innerHTML = `üëÅÔ∏è <b>Revelado</b> (sem pontuar)`;
  }

  quizFeedbackDetail.innerHTML = `
    Kanji: <b>${escapeHtml(k)}</b><br>
    Leituras: <b>${escapeHtml(r)}</b><br>
    Significados: <b>${escapeHtml(m)}</b>
  `;

  loadKanjiStrokeSVG(k, quizStroke);
}

function hideFeedback(){
  quizFeedback.style.display = "none";
  quizFeedbackTitle.textContent = "";
  quizFeedbackDetail.textContent = "";
}

function updateScoreUI(){
  quizScoreEl.textContent = `Acertos: ${quizState.correct} ¬∑ Erros: ${quizState.wrong} ¬∑ Streak: ${quizState.streak}`;
}

function updateBestUI(){
  const total = stats.totalCorrect + stats.totalWrong;
  const acc = total ? (stats.totalCorrect / total) : 0;
  bestStatsEl.innerHTML = `
    ‚Ä¢ Best streak: <b>${stats.bestStreak}</b><br>
    ‚Ä¢ Best accuracy: <b>${Math.round(stats.bestAccuracy*100)}%</b><br>
    ‚Ä¢ Best score (C‚àíE): <b>${stats.bestScore}</b><br>
    ‚Ä¢ Global accuracy: <b>${Math.round(acc*100)}%</b> (C:${stats.totalCorrect} / E:${stats.totalWrong})
  `;
}

function updateWorstUI(){
  const arr = Object.entries(stats.perKanji).map(([k,v])=>{
    const total = v.c + v.w;
    const err = total ? (v.w / total) : 0;
    return {k, c:v.c, w:v.w, total, err};
  }).filter(x=>x.total>0);

  arr.sort((a,b)=> (b.w - a.w) || (b.err - a.err));

  const top = arr.slice(0,10);
  if(!top.length){
    worstKanjisEl.textContent = "‚Äî";
    return;
  }
  worstKanjisEl.innerHTML = top.map(x=>{
    const pct = Math.round(x.err*100);
    return `‚Ä¢ <b>${escapeHtml(x.k)}</b> ‚Äî erros: ${x.w} / ${x.total} (${pct}%)`;
  }).join("<br>");
}

function updateAndPersistBests(){
  // best streak
  stats.bestStreak = Math.max(stats.bestStreak, quizState.streak);

  // best accuracy / best score s√£o por sess√£o atual (quizState)
  const total = quizState.correct + quizState.wrong;
  const acc = total ? (quizState.correct / total) : 0;
  const score = quizState.correct - quizState.wrong;

  stats.bestAccuracy = Math.max(stats.bestAccuracy, acc);
  stats.bestScore = Math.max(stats.bestScore, score);

  saveStats(stats);
  updateBestUI();
  updateWorstUI();
}

function lockChoiceButtons(lock){
  // desabilita clique depois que escolheu
  const btns = document.querySelectorAll(".choiceBtn");
  btns.forEach(b=>{
    b.disabled = !!lock;
    if(lock) b.style.pointerEvents = "none";
    else b.style.pointerEvents = "auto";
  });
}

function evaluateIfComplete(){
  if(!(quizState.answeredReading && quizState.answeredMeaning)) return;

  // Para pontuar: precisa 2/2 corretos
  const ok = quizState.chosenReading === "correct" && quizState.chosenMeaning === "correct";

  // update stats
  const k = quizState.current;
  ensurePerKanji(k);

  if(ok){
    quizState.correct += 1;
    quizState.streak += 1;
    stats.totalCorrect += 1;
    stats.perKanji[k].c += 1;
  }else{
    quizState.wrong += 1;
    quizState.streak = 0;
    stats.totalWrong += 1;
    stats.perKanji[k].w += 1;
  }

  updateScoreUI();
  updateAndPersistBests();
  showFeedback(true, ok);

  // para timer e auto next
  stopTimer();
  // auto next mais ‚Äúr√°pido‚Äù
  setTimeout(()=> nextQuestion(true), 800);
}

function renderChoiceButtons(kind, targetEl, options){
  targetEl.innerHTML = "";
  options.forEach(opt=>{
    const b = document.createElement("button");
    b.className = "choiceBtn";
    b.type = "button";
    b.textContent = opt.text;
    b.addEventListener("click", ()=>{
      // marca UI
      const allBtns = Array.from(targetEl.querySelectorAll(".choiceBtn"));
      allBtns.forEach(btn=> btn.disabled = true);

      // pinta certo/errado
      allBtns.forEach((btn, idx)=>{
        const o = options[idx];
        if(o.correct) btn.classList.add("correct");
      });

      if(opt.correct){
        b.classList.add("correct");
        if(kind==="reading"){
          quizState.answeredReading = true;
          quizState.chosenReading = "correct";
        }else{
          quizState.answeredMeaning = true;
          quizState.chosenMeaning = "correct";
        }
      }else{
        b.classList.add("wrong");
        if(kind==="reading"){
          quizState.answeredReading = true;
          quizState.chosenReading = "wrong";
        }else{
          quizState.answeredMeaning = true;
          quizState.chosenMeaning = "wrong";
        }
      }

      evaluateIfComplete();
    });

    targetEl.appendChild(b);
  });
}

function setQuizKanji(k, keepTimerRunning){
  quizState.current = k;
  quizKanji.textContent = k;

  resetChoicesUI();
  hideFeedback();

  // monta op√ß√µes
  const rOpts = buildChoices("reading", k);
  const mOpts = buildChoices("meaning", k);
  renderChoiceButtons("reading", readingChoices, rOpts);
  renderChoiceButtons("meaning", meaningChoices, mOpts);

  // timer
  if(quizState.running && !keepTimerRunning){
    // se estava rodando e troca manual, reinicia timer
    startTimer(true);
  }else if(quizState.running && keepTimerRunning){
    // mantem rodando, mas reinicia contagem pro novo kanji
    startTimer(true);
  }else{
    // n√£o rodando: setar barra para cheio
    const seconds = Number(quizTime.value);
    quizState.timeTotalMs = seconds * 1000;
    quizState.timeLeftMs = quizState.timeTotalMs;
    updateTimerUI();
  }
}

function nextQuestion(autopick){
  const k = autopick ? pickKanji() : pickKanji();
  setQuizKanji(k, true);
}

function updateTimerUI(){
  const leftSec = Math.max(0, Math.ceil(quizState.timeLeftMs/1000));
  quizTimerText.textContent = `‚è±Ô∏è ${leftSec}s`;
  const pct = quizState.timeTotalMs ? (quizState.timeLeftMs / quizState.timeTotalMs) : 0;
  timerBar.style.width = `${Math.max(0, Math.min(1, pct))*100}%`;
}

function tickTimer(){
  const step = 200;
  quizState.timeLeftMs -= step;
  updateTimerUI();
  if(quizState.timeLeftMs <= 0){
    // tempo acabou => erra a pergunta
    stopTimer();
    // for√ßa revelar e pontuar como errado (se n√£o respondeu tudo)
    const k = quizState.current;
    ensurePerKanji(k);

    // se n√£o completou, conta como erro
    quizState.wrong += 1;
    quizState.streak = 0;
    stats.totalWrong += 1;
    stats.perKanji[k].w += 1;

    updateScoreUI();
    updateAndPersistBests();

    showFeedback(true, false);
    // desabilita bot√µes
    const btns = document.querySelectorAll(".choiceBtn");
    btns.forEach(b=>{ b.disabled=true; b.style.pointerEvents="none"; });

    setTimeout(()=> nextQuestion(true), 900);
  }
}

function startTimer(reset){
  const seconds = Number(quizTime.value);
  quizState.timeTotalMs = seconds * 1000;
  if(reset) quizState.timeLeftMs = quizState.timeTotalMs;

  if(quizState.timerId) clearInterval(quizState.timerId);
  quizState.timerId = setInterval(tickTimer, 200);
  quizState.running = true;
  updateTimerUI();
}

function stopTimer(){
  if(quizState.timerId){
    clearInterval(quizState.timerId);
    quizState.timerId = null;
  }
  quizState.running = false;
}

quizStart.addEventListener("click", ()=>{
  startTimer(true);
});
quizPause.addEventListener("click", ()=>{
  if(quizState.running){
    stopTimer();
  }else{
    startTimer(false);
  }
});
quizNext.addEventListener("click", ()=>{
  nextQuestion(true);
});
quizReset.addEventListener("click", ()=>{
  stopTimer();
  quizState.correct = 0;
  quizState.wrong = 0;
  quizState.streak = 0;
  updateScoreUI();
  // n√£o zera ranking global (local), s√≥ sess√£o
  nextQuestion(true);
});

quizTime.addEventListener("change", ()=>{
  // se estiver rodando, reinicia no novo tempo
  if(quizState.running) startTimer(true);
  else{
    quizState.timeTotalMs = Number(quizTime.value)*1000;
    quizState.timeLeftMs = quizState.timeTotalMs;
    updateTimerUI();
  }
});

quizSmart.addEventListener("change", ()=>{
  // s√≥ muda sele√ß√£o
});

function pickKanji(){
  const pool = getPool();
  return quizSmart.checked ? weightedPick(pool) : pool[Math.floor(Math.random()*pool.length)];
}

/* =========================
   NAV events
   ========================= */
tabs.dic.addEventListener("click", ()=> openTab("dic"));
tabs.kanji.addEventListener("click", ()=> openTab("kanji"));
tabs.quiz.addEventListener("click", ()=> openTab("quiz"));
tabs.about.addEventListener("click", ()=> openTab("about"));

/* =========================
   INIT
   ========================= */
updateModeUI();
updateScoreUI();
updateBestUI();
updateWorstUI();
renderResults("");
setQuizKanji("‰∏Ä", false);
</script>

</body>
</html>
