<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢å…¨çŸ¥å…¨èƒ½ è¾å…¸</title>

<style>
:root{
  --bg:#0b0f14;
  --panel:#151822;
  --border:#252a36;
  --text:#e6e8ee;
  --muted:#9aa0aa;
  --muted2:#7b8192;

  --accent:#7b5cff;
  --accent2:#36d1dc;
  --accent3:#fb7185;

  --radius:16px;
  --shadow: 0 18px 65px rgba(0,0,0,.45);
}

*{box-sizing:border-box}

body{
  background:
    radial-gradient(1200px 700px at 10% 10%, rgba(123,92,255,.22), transparent 55%),
    radial-gradient(900px 600px at 90% 15%, rgba(54,209,220,.16), transparent 55%),
    radial-gradient(900px 650px at 20% 90%, rgba(251,113,133,.12), transparent 55%),
    var(--bg);
  color:var(--text);
  font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",system-ui,sans-serif;
  margin:0;
  line-height:1.95;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  background: rgba(11,15,20,.72);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border-bottom:1px solid var(--border);
}

.topbar{
  max-width:1150px;
  margin:auto;
  padding:18px 18px 12px;
  display:flex;
  gap:18px;
  align-items:flex-start;
  justify-content:space-between;
  flex-wrap:wrap;
}

.brand{min-width:280px;}
.brand .t{
  font-size:20px;
  font-weight:800;
  letter-spacing:1.4px;
}
.brand .s{
  margin-top:6px;
  color:var(--muted);
  font-size:13px;
}
.brand .s span{color:var(--muted2);}

nav{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
}

.tabbtn{
  cursor:pointer;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color:var(--muted);
  padding:9px 12px;
  border-radius:999px;
  font-size:13px;
  user-select:none;
  transition: transform .08s ease, background .2s ease, color .2s ease, border-color .2s ease;
  box-shadow: var(--shadow);
}
.tabbtn:active{ transform: translateY(1px); }
.tabbtn.active{
  color:var(--text);
  border-color: rgba(54,209,220,.35);
  background: linear-gradient(90deg, rgba(123,92,255,.18), rgba(54,209,220,.15), rgba(251,113,133,.12));
}

.container{
  max-width:1150px;
  margin:auto;
  padding:34px 18px 90px;
}

.section{ display:none; }
.section.active{ display:block; }

.grid{
  display:grid;
  grid-template-columns: 1.15fr .85fr;
  gap:16px;
}
@media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

.panel{
  background: rgba(255,255,255,.06);
  border:1px solid var(--border);
  border-radius:22px;
  padding:16px;
  box-shadow: var(--shadow);
}

.panel h2{
  margin: 0 0 8px;
  font-size: 15px;
  letter-spacing:.6px;
}

.hint{
  color:var(--muted);
  font-size:13px;
  margin-top:0;
}

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}

.searchbox{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.searchbox input{
  flex: 1 1 320px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  color:var(--text);
  outline:none;
}
.searchbox input::placeholder{ color:var(--muted2); }

.toggle{
  display:flex;
  align-items:center;
  gap:8px;
  color:var(--muted);
  font-size:12px;
  user-select:none;
}
.toggle input{ transform: translateY(1px); }

.btn{
  cursor:pointer;
  border:1px solid var(--border);
  background: rgba(255,255,255,.05);
  color:var(--text);
  padding:8px 10px;
  border-radius:12px;
  font-size:12px;
  user-select:none;
}
.btn.primary{
  border-color: rgba(54,209,220,.35);
  background: rgba(54,209,220,.12);
}
.btn.danger{
  border-color: rgba(251,113,133,.35);
  background: rgba(251,113,133,.10);
}

.card{
  background: rgba(255,255,255,.07);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding:16px;
  margin-top:12px;
}
.card.exact{
  border-color: rgba(54,209,220,.38);
  box-shadow: 0 0 0 1px rgba(54,209,220,.08), var(--shadow);
}

.jp{
  font-size:22px;
  font-weight:900;
  letter-spacing:.5px;
  color:var(--accent2);
}
.hira{
  margin-top:6px;
  color:var(--muted);
  font-size:13px;
}
.mean{
  margin-top:8px;
  font-size:14px;
  color:var(--text);
  font-weight:600;
}

.badges{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
.badge{
  font-size:11px;
  border:1px solid var(--border);
  padding:3px 8px;
  border-radius:999px;
  color:var(--muted);
}
.badge.n5{ border-color: rgba(52,211,153,.35); color: rgba(52,211,153,.95); }
.badge.n4{ border-color: rgba(123,92,255,.45); color: rgba(123,92,255,.95); }
.badge.tag{ border-color: rgba(54,209,220,.35); color: rgba(54,209,220,.95); }
.badge.exact{ border-color: rgba(54,209,220,.55); color: rgba(54,209,220,.95); }

.ex{
  margin-top:14px;
  padding-top:12px;
  border-top:1px solid rgba(255,255,255,.08);
}
.ex h4{
  margin:0 0 6px;
  font-size:13px;
  color:var(--accent2);
}
.exline{ margin:10px 0 10px; }
.exline b{ color:var(--text); }
.exline .k{ color:var(--accent2); }
.exp{
  color:var(--muted);
  font-size:13px;
  margin-top:6px;
}

.kanjigrid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(92px, 1fr));
  gap:12px;
  margin-top:12px;
}
.kanjiitem{
  background: rgba(255,255,255,.06);
  border:1px solid var(--border);
  border-radius: 16px;
  padding:12px 10px;
  text-align:center;
  cursor:pointer;
  transition: transform .12s ease, border-color .2s ease;
}
.kanjiitem:hover{
  transform: translateY(-1px);
  border-color: rgba(54,209,220,.28);
}
.kanjiitem .k{
  font-size:28px;
  font-weight:900;
  color:var(--accent2);
}
.kanjiitem .lvl{
  margin-top:6px;
  font-size:11px;
  color:var(--muted);
}
.kanjiitem .lvl b{ color:var(--text); }

hr.sep{
  border:none;
  border-top:1px solid rgba(255,255,255,.08);
  margin:14px 0;
}
.small{
  color:var(--muted);
  font-size:13px;
}
.small b{ color:var(--text); }

.footer{
  text-align:center;
  padding:40px 0 0;
  color:var(--muted);
  font-size:12px;
}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="t">ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢å…¨çŸ¥å…¨èƒ½ è¾å…¸</div>
      <div class="s">
        ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢ = vampiro <span>ï¼ˆobservador eternoï¼‰</span> / å…¨çŸ¥ = onisciente / å…¨èƒ½ = onipotente
      </div>
    </div>

    <nav>
      <div class="tabbtn active" id="tab-dic">ğŸ“– DicionÃ¡rio</div>
      <div class="tabbtn" id="tab-kanji">ğŸˆ¶ Kanji (N5â†’N4)</div>
      <div class="tabbtn" id="tab-about">â„¹ï¸ Sobre</div>
    </nav>
  </div>
</header>

<div class="container">

  <!-- ====================== DICIONÃRIO ====================== -->
  <section id="dic" class="section active">
    <div class="grid">
      <div class="panel">
        <div class="row">
          <div>
            <h2>DicionÃ¡rio (JP â†’ PT-BR)</h2>
            <p class="hint">
              Busca ranqueada (exato primeiro). Aceita kanji/kana/portuguÃªs.
              Ex.: é£Ÿã¹ã‚‹ / ã’ã‚“ã / â€œatrasarâ€.
            </p>
          </div>

          <label class="toggle" title="Se existir uma entrada exata, mostra sÃ³ ela.">
            <input type="checkbox" id="onlyExact" />
            sÃ³ exato (quando houver)
          </label>
        </div>

        <div class="searchbox">
          <input id="q" type="text" placeholder="Buscar palavra..." autocomplete="off" />
          <div class="btn danger" id="btnClear">Limpar</div>
        </div>

        <div id="results"></div>
      </div>

      <div class="panel">
        <h2>Uso / MÃ©todo</h2>
        <p class="small">
          1) Busque a palavra â†’ confirme leitura e significado.<br>
          2) Leia as 3 frases (JP â†’ hiragana â†’ PT).<br>
          3) Entenda as estruturas na explicaÃ§Ã£o (partÃ­culas/tempo/padrÃ£o).<br>
          4) FaÃ§a variaÃ§Ãµes: troque lugar/tempo/objeto mantendo o padrÃ£o.<br>
        </p>

        <hr class="sep" />

        <div class="row">
          <div class="btn primary" id="btnRandom">Palavra aleatÃ³ria</div>
          <div class="btn" id="btnGoKanji">Ver kanji (N5â†’N4)</div>
        </div>

        <hr class="sep" />

        <p class="small">
          <b>Meta 2000:</b> este arquivo suporta 2000+ itens sem travar porque renderiza sÃ³ os melhores resultados.
          VocÃª sÃ³ precisa adicionar entradas no array <b>WORDS</b>.
        </p>
      </div>
    </div>
  </section>

  <!-- ====================== KANJI LISTA ====================== -->
  <section id="kanji" class="section">
    <div class="panel">
      <h2>Kanji â€” ordem N5 â†’ N4</h2>
      <p class="hint">
        Clique num kanji para abrir o DicionÃ¡rio e buscar automaticamente.
        (Se ainda nÃ£o houver ficha no dicionÃ¡rio, o site mostra aviso.)
      </p>
      <div class="kanjigrid" id="kanjigrid"></div>
    </div>
  </section>

  <!-- ====================== SOBRE ====================== -->
  <section id="about" class="section">
    <div class="panel">
      <h2>Sobre â€” ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢å…¨çŸ¥å…¨èƒ½</h2>
      <p class="small">
        Este dicionÃ¡rio faz parte do projeto <b>ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢å…¨çŸ¥å…¨èƒ½</b>.<br>
        O foco Ã© japonÃªs de verdade (N5â†’N4): <b>palavra â†’ 3 frases â†’ explicaÃ§Ã£o detalhada em PT-BR</b>.<br><br>
        â€œVampiroâ€ Ã© metÃ¡fora do observador que coleta padrÃµes do cotidiano.<br>
        â€œå…¨çŸ¥å…¨èƒ½â€ representa disciplina: aprender por sistema, sem pular base.
      </p>
      <hr class="sep">
      <p class="small">
        Identidade, estrutura e curadoria: <b>ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢å…¨çŸ¥å…¨èƒ½</b>.
      </p>
    </div>
  </section>

  <div class="footer">ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢å…¨çŸ¥å…¨èƒ½ Â© 2025 â€” è¾å…¸ / Kanji / Estudo do cotidiano</div>
</div>

<script>
/* =========================
   DADOS: DICIONÃRIO (WORDS)
   Cada entrada precisa:
   jp, hira, tipo, mean, tags, examples[3] {jp,hira,pt,exp}
   ========================= */
const WORDS = [
  {
    jp:"é£Ÿã¹ã‚‹",
    hira:"ãŸã¹ã‚‹",
    tipo:"verbo (ichidan)",
    mean:"comer",
    tags:["N5","cotidiano"],
    examples:[
      { jp:"æœã”ã¯ã‚“ã‚’é£Ÿã¹ã¾ã—ãŸã€‚", hira:"ã‚ã•ã”ã¯ã‚“ ã‚’ ãŸã¹ã¾ã—ãŸã€‚", pt:"Comi cafÃ© da manhÃ£.", exp:"æœã”ã¯ã‚“ = cafÃ© da manhÃ£; ã‚’ = objeto; ã€œã¾ã—ãŸ = passado polido." },
      { jp:"ä½•ã‚’é£Ÿã¹ãŸã„ã§ã™ã‹ï¼Ÿ", hira:"ãªã« ã‚’ ãŸã¹ãŸã„ ã§ã™ ã‹ï¼Ÿ", pt:"O que vocÃª quer comer?", exp:"ã€œãŸã„ = querer; ã§ã™ã‹ = pergunta educada." },
      { jp:"å‹ã ã¡ã¨æ˜¼ã”ã¯ã‚“ã‚’é£Ÿã¹ã«è¡Œãã¾ã™ã€‚", hira:"ã¨ã‚‚ã ã¡ ã¨ ã²ã‚‹ã”ã¯ã‚“ ã‚’ ãŸã¹ ã« ã„ãã¾ã™ã€‚", pt:"Vou almoÃ§ar com um amigo.", exp:"Vã¾ã™-stem + ã«è¡Œã = ir para fazer algo (é£Ÿã¹ã¾ã™â†’é£Ÿã¹)." }
    ]
  },
  {
    jp:"å…ƒæ°—",
    hira:"ã’ã‚“ã",
    tipo:"ãª-adjetivo / substantivo",
    mean:"bem, saudÃ¡vel, animado",
    tags:["N5","cotidiano"],
    examples:[
      { jp:"å…ƒæ°—ã§ã™ã‹ï¼Ÿ", hira:"ã’ã‚“ã ã§ã™ ã‹ï¼Ÿ", pt:"Tudo bem?", exp:"Pergunta padrÃ£o. ã§ã™ + ã‹ = pergunta educada." },
      { jp:"ä»Šæ—¥ã¯å…ƒæ°—ãŒãªã„ã­ã€‚", hira:"ãã‚‡ã† ã¯ ã’ã‚“ã ãŒ ãªã„ ã­ã€‚", pt:"Hoje vocÃª nÃ£o parece bem.", exp:"ã€œãŒãªã„ = nÃ£o ter (energia/Ã¢nimo). ã­ = tom de conversa." },
      { jp:"å­ã©ã‚‚ãŸã¡ã¯å…ƒæ°—ã«èµ°ã£ã¦ã„ã¾ã™ã€‚", hira:"ã“ã©ã‚‚ãŸã¡ ã¯ ã’ã‚“ã ã« ã¯ã—ã£ã¦ ã„ã¾ã™ã€‚", pt:"As crianÃ§as estÃ£o correndo cheias de energia.", exp:"å…ƒæ°—ã« = advÃ©rbio (com energia); ã€œã¦ã„ã‚‹ = aÃ§Ã£o em andamento." }
    ]
  },
  {
    jp:"å¤§ä¸ˆå¤«",
    hira:"ã ã„ã˜ã‚‡ã†ã¶",
    tipo:"ãª-adjetivo / expressÃ£o",
    mean:"tudo bem; tranquilo; sem problemas",
    tags:["N5","cotidiano"],
    examples:[
      { jp:"å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿ", hira:"ã ã„ã˜ã‚‡ã†ã¶ ã§ã™ ã‹ï¼Ÿ", pt:"VocÃª estÃ¡ bem?", exp:"Serve para saÃºde, situaÃ§Ã£o e tambÃ©m entendimento." },
      { jp:"å¤§ä¸ˆå¤«ã€é–“ã«åˆã†ã‚ˆã€‚", hira:"ã ã„ã˜ã‚‡ã†ã¶ã€ã¾ã«ã‚ã† ã‚ˆã€‚", pt:"Tranquilo, vai dar tempo.", exp:"é–“ã«åˆã† = dar tempo; ã‚ˆ = certeza/seguranÃ§a." },
      { jp:"ã“ã®æœã§å¤§ä¸ˆå¤«ï¼Ÿ", hira:"ã“ã® ãµã ã§ ã ã„ã˜ã‚‡ã†ã¶ï¼Ÿ", pt:"Essa roupa tÃ¡ ok assim?", exp:"ã§ = condiÃ§Ã£o/estado ('com isso'); frase casual." }
    ]
  },
  {
    jp:"é…ã‚Œã‚‹",
    hira:"ãŠãã‚Œã‚‹",
    tipo:"verbo (ichidan)",
    mean:"atrasar-se; atrasar",
    tags:["N4","cotidiano"],
    examples:[
      { jp:"ã”ã‚ã‚“ã€å°‘ã—é…ã‚Œã‚‹ã€‚", hira:"ã”ã‚ã‚“ã€ã™ã“ã— ãŠãã‚Œã‚‹ã€‚", pt:"Foi mal, vou me atrasar um pouco.", exp:"Mensagem real do dia a dia. ã™ã“ã— = um pouco." },
      { jp:"é›»è»ŠãŒé…ã‚Œã¦ã„ã‚‹ã€‚", hira:"ã§ã‚“ã—ã‚ƒ ãŒ ãŠãã‚Œã¦ã„ã‚‹ã€‚", pt:"O trem estÃ¡ atrasado.", exp:"ã€œã¦ã„ã‚‹ = estado atual (continua atrasado agora)." },
      { jp:"é€£çµ¡ãŒé…ã‚Œã¦ã™ã¿ã¾ã›ã‚“ã€‚", hira:"ã‚Œã‚“ã‚‰ã ãŒ ãŠãã‚Œã¦ ã™ã¿ã¾ã›ã‚“ã€‚", pt:"Desculpa a demora em responder/avisar.", exp:"ExpressÃ£o padrÃ£o em chat/e-mail." }
    ]
  }
];

/* =========================
   KANJI: ORDEM N5 (exata) + N4 placeholder
   ========================= */
const KANJI_ORDER = [
  // N5 (ordem exata que vocÃª mandou)
  {k:"ä¸€", lvl:"N5"},{k:"ä¸ƒ", lvl:"N5"},{k:"ä¸‡", lvl:"N5"},{k:"ä¸‰", lvl:"N5"},{k:"ä¸Š", lvl:"N5"},{k:"ä¸‹", lvl:"N5"},
  {k:"ä¸­", lvl:"N5"},{k:"ä¹", lvl:"N5"},{k:"äºŒ", lvl:"N5"},{k:"äº”", lvl:"N5"},{k:"äºº", lvl:"N5"},{k:"ä»Š", lvl:"N5"},
  {k:"ä¼‘", lvl:"N5"},{k:"ä½•", lvl:"N5"},{k:"å…ˆ", lvl:"N5"},{k:"å…¥", lvl:"N5"},{k:"å…«", lvl:"N5"},{k:"å…­", lvl:"N5"},
  {k:"å††", lvl:"N5"},{k:"å‡º", lvl:"N5"},{k:"åˆ†", lvl:"N5"},{k:"å‰", lvl:"N5"},{k:"åŒ—", lvl:"N5"},{k:"å", lvl:"N5"},
  {k:"åƒ", lvl:"N5"},{k:"åˆ", lvl:"N5"},{k:"åŠ", lvl:"N5"},{k:"å—", lvl:"N5"},{k:"å‹", lvl:"N5"},{k:"å³", lvl:"N5"},
  {k:"å", lvl:"N5"},{k:"å››", lvl:"N5"},{k:"å›½", lvl:"N5"},{k:"åœŸ", lvl:"N5"},{k:"å¤–", lvl:"N5"},{k:"å¤§", lvl:"N5"},
  {k:"å¤©", lvl:"N5"},{k:"å¥³", lvl:"N5"},{k:"å­", lvl:"N5"},{k:"å­¦", lvl:"N5"},{k:"å°", lvl:"N5"},{k:"å±±", lvl:"N5"},
  {k:"å·", lvl:"N5"},{k:"å·¦", lvl:"N5"},{k:"å¹´", lvl:"N5"},{k:"å¾Œ", lvl:"N5"},{k:"æ—¥", lvl:"N5"},{k:"æ™‚", lvl:"N5"},
  {k:"æ›¸", lvl:"N5"},{k:"æœˆ", lvl:"N5"},{k:"æœ¨", lvl:"N5"},{k:"æœ¬", lvl:"N5"},{k:"æ¥", lvl:"N5"},{k:"æ±", lvl:"N5"},
  {k:"æ ¡", lvl:"N5"},{k:"æ¯", lvl:"N5"},{k:"æ¯", lvl:"N5"},{k:"æ°—", lvl:"N5"},{k:"æ°´", lvl:"N5"},{k:"ç«", lvl:"N5"},
  {k:"çˆ¶", lvl:"N5"},{k:"ç”Ÿ", lvl:"N5"},{k:"ç”·", lvl:"N5"},{k:"ç™½", lvl:"N5"},{k:"ç™¾", lvl:"N5"},{k:"è", lvl:"N5"},
  {k:"è¡Œ", lvl:"N5"},{k:"è¥¿", lvl:"N5"},{k:"è¦‹", lvl:"N5"},{k:"è©±", lvl:"N5"},{k:"èª", lvl:"N5"},{k:"èª­", lvl:"N5"},
  {k:"è»Š", lvl:"N5"},{k:"é‡‘", lvl:"N5"},{k:"é•·", lvl:"N5"},{k:"é–“", lvl:"N5"},{k:"é›¨", lvl:"N5"},{k:"é›»", lvl:"N5"},
  {k:"é£Ÿ", lvl:"N5"},{k:"é«˜", lvl:"N5"},

  // N4 (placeholder â€“ vocÃª vai expandindo depois)
  {k:"è€ƒ", lvl:"N4"},{k:"ç¶š", lvl:"N4"},{k:"å›°", lvl:"N4"},{k:"æ±º", lvl:"N4"},{k:"äºˆ", lvl:"N4"},{k:"å¤‰", lvl:"N4"},
  {k:"é…", lvl:"N4"},{k:"å¿˜", lvl:"N4"},{k:"è¿”", lvl:"N4"},{k:"ç›´", lvl:"N4"},{k:"ç½®", lvl:"N4"},{k:"èµ·", lvl:"N4"},
  {k:"çœ ", lvl:"N4"},{k:"ä¹—", lvl:"N4"},{k:"é™", lvl:"N4"}
];

/* =========================
   ESTADO / DOM
   ========================= */
const sections = {
  dic: document.getElementById("dic"),
  kanji: document.getElementById("kanji"),
  about: document.getElementById("about"),
};

const tabs = {
  dic: document.getElementById("tab-dic"),
  kanji: document.getElementById("tab-kanji"),
  about: document.getElementById("tab-about"),
};

const q = document.getElementById("q");
const results = document.getElementById("results");
const onlyExactEl = document.getElementById("onlyExact");
const kanjigrid = document.getElementById("kanjigrid");

const btnClear = document.getElementById("btnClear");
const btnRandom = document.getElementById("btnRandom");
const btnGoKanji = document.getElementById("btnGoKanji");

/* =========================
   UTIL: normalizaÃ§Ã£o robusta
   ========================= */
function normalize(s){
  return (s ?? "")
    .toString()
    .trim()
    .toLowerCase()
    .replace(/[\sã€€]+/g, "")
    .replace(/[ã€‚ã€ï¼Œ,.!?ï¼ï¼Ÿã€Œã€ã€ã€ï¼ˆï¼‰()ã€ã€‘\[\]""'â€™]/g, "");
}

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   BUSCA: ranking e exato
   ========================= */
function isExactHeadword(word, qNorm){
  const jp = normalize(word.jp);
  const hira = normalize(word.hira);
  const mean = normalize(word.mean);
  return (jp && jp === qNorm) || (hira && hira === qNorm) || (mean && mean === qNorm);
}

function scoreWord(word, qNorm){
  const jp = normalize(word.jp);
  const hira = normalize(word.hira);
  const mean = normalize(word.mean);

  // 1) Exato
  if(jp === qNorm) return 1000;
  if(hira === qNorm) return 950;
  if(mean === qNorm) return 900;

  // 2) ComeÃ§a com
  if(jp.startsWith(qNorm)) return 780;
  if(hira.startsWith(qNorm)) return 740;
  if(mean.startsWith(qNorm)) return 700;

  // 3) ContÃ©m
  if(jp.includes(qNorm)) return 520;
  if(hira.includes(qNorm)) return 500;
  if(mean.includes(qNorm)) return 480;

  // 4) Exemplos (menor prioridade)
  const ex = (word.examples || []);
  let best = 0;
  for(const e of ex){
    const ejp = normalize(e.jp);
    const ehira = normalize(e.hira);
    const ept = normalize(e.pt);
    const eexp = normalize(e.exp);
    if(ejp === qNorm || ehira === qNorm || ept === qNorm) best = Math.max(best, 360);
    else if(ejp.includes(qNorm) || ehira.includes(qNorm) || ept.includes(qNorm) || eexp.includes(qNorm)) best = Math.max(best, 220);
  }

  // 5) Tags/Tipo
  const tags = (word.tags || []).map(normalize);
  const tipo = normalize(word.tipo);
  if(tags.some(t => t.includes(qNorm))) best = Math.max(best, 180);
  if(tipo.includes(qNorm)) best = Math.max(best, 160);

  return best;
}

function renderExamples(examples){
  if(!examples || !examples.length){
    return `<div class="ex"><h4>Exemplos</h4><div class="exp">Sem exemplos ainda. (Adicione 3 frases com explicaÃ§Ã£o.)</div></div>`;
  }
  return examples.slice(0,3).map((e, idx)=>`
    <div class="ex">
      <h4>Exemplo ${idx+1}</h4>
      <div class="exline">
        <b>${escapeHtml(e.jp || "")}</b><br>
        <span class="k">${escapeHtml(e.hira || "")}</span><br>
        ${escapeHtml(e.pt || "")}
      </div>
      <div class="exp"><b>ExplicaÃ§Ã£o (PT-BR):</b> ${escapeHtml(e.exp || "")}</div>
    </div>
  `).join("");
}

function renderResults(raw){
  const query = (raw ?? q.value).trim();
  results.innerHTML = "";

  if(!query){
    results.innerHTML = `<div class="card"><div class="mean" style="color:var(--muted)">Digite algo para buscar. Ex.: é£Ÿã¹ã‚‹ / ã’ã‚“ã / â€œatrasarâ€.</div></div>`;
    return;
  }

  const qNorm = normalize(query);

  const ranked = WORDS
    .map(w => ({ w, s: scoreWord(w, qNorm) }))
    .filter(x => x.s > 0)
    .sort((a,b)=> b.s - a.s);

  if(!ranked.length){
    results.innerHTML = `
      <div class="card">
        <div class="mean">Nenhum resultado para â€œ${escapeHtml(query)}â€.</div>
        <div class="hira">
          Se vocÃª clicou num kanji, ainda nÃ£o existe ficha dele no dicionÃ¡rio.
          (Depois vocÃª adiciona uma entrada em WORDS com 3 frases.)
        </div>
      </div>`;
    return;
  }

  const exact = ranked.filter(x => isExactHeadword(x.w, qNorm));
  const nonExact = ranked.filter(x => !isExactHeadword(x.w, qNorm));

  const onlyExact = !!onlyExactEl.checked;
  const finalList = exact.length ? (onlyExact ? exact : [...exact, ...nonExact]) : ranked;

  // CabeÃ§alho
  const header = document.createElement("div");
  header.className = "card";
  header.innerHTML = `
    <div class="mean">
      Busca: <b>${escapeHtml(query)}</b> â€” resultados: <b>${finalList.length}</b>
      ${exact.length ? `&nbsp;&nbsp;<span class="badge exact">exato encontrado</span>` : ``}
    </div>
    <div class="hira">
      Dica: se quiser sÃ³ a entrada exata, marque â€œsÃ³ exato (quando houver)â€.
    </div>
  `;
  results.appendChild(header);

  // Render top 30 por performance
  const LIMIT = 30;
  finalList.slice(0, LIMIT).forEach(item=>{
    const w = item.w;
    const isExact = isExactHeadword(w, qNorm);

    const levelBadges = (w.tags || []).map(t=>{
      const low = (t || "").toString().toLowerCase();
      if(low === "n5") return `<span class="badge n5">N5</span>`;
      if(low === "n4") return `<span class="badge n4">N4</span>`;
      return `<span class="badge tag">${escapeHtml(t)}</span>`;
    }).join("");

    const card = document.createElement("div");
    card.className = "card" + (isExact ? " exact" : "");
    card.innerHTML = `
      <div class="jp">${escapeHtml(w.jp)}</div>
      <div class="hira">${escapeHtml(w.hira || "â€”")}</div>
      <div class="mean">(${escapeHtml(w.tipo || "â€”")}) â€” ${escapeHtml(w.mean || "â€”")}</div>
      <div class="badges">
        ${isExact ? `<span class="badge exact">resultado exato</span>` : ``}
        ${levelBadges}
      </div>
      ${renderExamples(w.examples || [])}
    `;
    results.appendChild(card);
  });

  if(finalList.length > LIMIT){
    const more = document.createElement("div");
    more.className = "card";
    more.innerHTML = `
      <div class="mean">Mostrando os <b>${LIMIT}</b> melhores resultados (de ${finalList.length}).</div>
      <div class="hira">Refine a busca: use kana/kanji exatos (ex.: ã¾ã«ã‚ã† / é–“ã«åˆã†) ou PT especÃ­fico.</div>
    `;
    results.appendChild(more);
  }
}

/* =========================
   KANJI GRID
   ========================= */
function renderKanjiGrid(){
  kanjigrid.innerHTML = "";

  // Ordem jÃ¡ vem N5â†’N4; se quiser garantir:
  const rank = (lvl)=> lvl === "N5" ? 0 : 1;
  const list = [...KANJI_ORDER].sort((a,b)=> rank(a.lvl) - rank(b.lvl));

  list.forEach(item=>{
    const div = document.createElement("div");
    div.className = "kanjiitem";
    div.innerHTML = `
      <div class="k">${escapeHtml(item.k)}</div>
      <div class="lvl"><b>${escapeHtml(item.lvl)}</b> ãƒ» clique</div>
    `;
    div.addEventListener("click", ()=>{
      openTab("dic");
      q.value = item.k;
      renderResults(item.k);
      window.scrollTo({top:0, behavior:"smooth"});
    });
    kanjigrid.appendChild(div);
  });
}

/* =========================
   TAB NAV
   ========================= */
function openTab(id){
  Object.values(sections).forEach(s=>s.classList.remove("active"));
  Object.values(tabs).forEach(t=>t.classList.remove("active"));

  sections[id].classList.add("active");
  tabs[id].classList.add("active");

  if(id === "kanji") renderKanjiGrid();
  if(id === "dic") setTimeout(()=>q.focus(), 0);
}

/* =========================
   EVENTS (com debounce leve)
   ========================= */
let debounceTimer = null;
function onSearchInput(){
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(()=> renderResults(q.value), 80);
}

q.addEventListener("input", onSearchInput);
onlyExactEl.addEventListener("change", ()=> renderResults(q.value));

btnClear.addEventListener("click", ()=>{
  q.value = "";
  renderResults("");
  q.focus();
});

btnRandom.addEventListener("click", ()=>{
  if(!WORDS.length) return;
  const pick = WORDS[Math.floor(Math.random() * WORDS.length)];
  q.value = pick.jp;
  renderResults(pick.jp);
});

btnGoKanji.addEventListener("click", ()=> openTab("kanji"));

tabs.dic.addEventListener("click", ()=> openTab("dic"));
tabs.kanji.addEventListener("click", ()=> openTab("kanji"));
tabs.about.addEventListener("click", ()=> openTab("about"));

/* =========================
   INIT
   ========================= */
renderResults("");
</script>

</body>
</html>
