<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ヴァンパイア全知全能</title>
  <style>
    :root{
      --bg0:#0b0f1a;
      --bg1:#0f172a;
      --card:#111b34;
      --card2:#0c1328;
      --text:#e7ecff;
      --muted:#aab6e8;

      --accent:#7c3aed;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;

      --line:rgba(255,255,255,.10);
      --shadow: 0 20px 60px rgba(0,0,0,.35);

      --mood:#223055;
      --mood2:#141c34;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% -10%, rgba(124,58,237,.35), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(1100px 700px at 50% 120%, rgba(239,68,68,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      transition: background .18s ease;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:18px;}
    header{
      background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      padding:18px 18px 12px;
      box-shadow: var(--shadow);
      position:sticky;
      top:10px;
      z-index:10;
      backdrop-filter: blur(10px);
    }
    .topRow{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: radial-gradient(circle at 35% 25%, rgba(255,255,255,.35), transparent 45%),
                  linear-gradient(135deg, var(--accent), #06b6d4);
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 10px 30px rgba(124,58,237,.25);
    }
    h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .sub{
      margin:2px 0 0;
      color:var(--muted);
      font-size:12px;
    }
    .pillRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
      display:flex;gap:8px;align-items:center;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:var(--accent);
      box-shadow:0 0 0 4px rgba(124,58,237,.18);
    }

    .tabs{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .tabBtn{
      cursor:pointer;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-weight:650;
      font-size:13px;
      transition:.15s transform, .15s background, .15s border;
      user-select:none;
    }
    .tabBtn:hover{transform: translateY(-1px);background: rgba(255,255,255,.06)}
    .tabBtn.active{
      background: linear-gradient(135deg, rgba(124,58,237,.28), rgba(6,182,212,.14));
      border-color: rgba(124,58,237,.55);
    }

    main{margin-top:14px;display:grid;gap:14px}
    .grid2{display:grid;grid-template-columns: 1.1fr .9fr;gap:14px}
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr} header{position:relative;top:auto} }

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background: linear-gradient(135deg, rgba(255,255,255,.05), rgba(255,255,255,.01));
    }
    .cardHd h2{margin:0;font-size:14px;letter-spacing:.2px}
    .cardBd{padding:14px 16px}

    .kHero{
      display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;
    }
    .kBig{
      width:90px;height:90px;border-radius:22px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.12), transparent 55%),
                  linear-gradient(135deg, rgba(124,58,237,.35), rgba(6,182,212,.12));
      border:1px solid rgba(255,255,255,.15);
      font-size:44px;font-weight:800;
      box-shadow: 0 14px 50px rgba(0,0,0,.35);
    }

    .kMeta{min-width:260px;flex:1}
    .kLine{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .tag{
      font-size:12px;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--muted);
    }
    .tag strong{color:var(--text)}
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
      margin-top:8px;
    }

    .strokeBox{
      width:240px;
      max-width:100%;
      background: linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.10));
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
    }
    .strokeTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:8px;
    }
    .strokeTop .mini{color:var(--muted);font-size:12px}
    .btn{
      cursor:pointer;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color:var(--text);
      font-weight:750;
      font-size:13px;
      transition: .15s transform, .15s background, .15s border;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px);background: rgba(255,255,255,.11)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.8), rgba(6,182,212,.55));
      border-color: rgba(124,58,237,.55);
    }
    .btn.good{
      background: linear-gradient(135deg, rgba(34,197,94,.85), rgba(16,185,129,.45));
      border-color: rgba(34,197,94,.6);
    }
    .btn.bad{
      background: linear-gradient(135deg, rgba(239,68,68,.85), rgba(244,63,94,.45));
      border-color: rgba(239,68,68,.6);
    }
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}

    .controls{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .select, .input{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,30,.85);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      font-weight:650;
      font-size:13px;
    }
    .select option{background:#0b1024;color:var(--text)}
    .input{min-width:220px;flex:1}
    .muted{color:var(--muted)}

    .kGrid{
      display:grid;
      grid-template-columns: repeat(10, minmax(0,1fr));
      gap:8px;
    }
    @media (max-width: 980px){ .kGrid{grid-template-columns: repeat(8, minmax(0,1fr));} }
    @media (max-width: 640px){ .kGrid{grid-template-columns: repeat(6, minmax(0,1fr));} }

    .kBtn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.08));
      border-radius:16px;
      padding:10px 0;
      font-size:22px;
      font-weight:800;
      color:var(--text);
      transition:.14s transform,.14s border,.14s background;
      user-select:none;
    }
    .kBtn:hover{transform: translateY(-1px);border-color: rgba(124,58,237,.45);background: rgba(124,58,237,.12)}
    .kBtn.active{border-color: rgba(6,182,212,.55);background: rgba(6,182,212,.14)}

    .list{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:8px;
    }
    .li{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(0,0,0,.14);
    }
    .liTop{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .jp{font-weight:850}
    .fur{color:var(--muted);font-size:12px}
    .gloss{color:var(--text);opacity:.92;font-size:13px;margin-top:6px}

    /* quiz */
    .quizCard{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.10));
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px 16px;
      position:relative;
      overflow:hidden;
    }
    .quizCard::before{
      content:"";
      position:absolute; inset:-120px -120px auto auto;
      width:260px;height:260px;border-radius:50%;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.12), transparent 55%),
                  radial-gradient(circle at 50% 50%, rgba(124,58,237,.25), transparent 60%);
      transform: rotate(15deg);
    }
    .quizTop{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;position:relative}
    .score{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .score .pill{background: rgba(0,0,0,.18)}
    .qMain{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;position:relative;margin-top:12px}
    .qKanji{
      width:96px;height:96px;border-radius:24px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(255,255,255,.07), rgba(0,0,0,.12));
      font-size:48px;font-weight:900;
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }
    .qText{flex:1;min-width:240px}
    .qTitle{margin:0;font-size:14px;color:var(--muted)}
    .qPrompt{margin:6px 0 0;font-size:18px;font-weight:850;letter-spacing:.2px}
    .choices{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 640px){ .choices{grid-template-columns:1fr} }
    .choice{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,30,.75);
      border-radius:16px;
      padding:12px 12px;
      font-weight:850;
      transition:.14s transform,.14s border,.14s background;
      user-select:none;
      text-align:left;
    }
    .choice:hover{transform: translateY(-1px);border-color: rgba(124,58,237,.45);background: rgba(124,58,237,.14)}
    .choice.locked{cursor:default;opacity:.95}
    .choice.correct{border-color: rgba(34,197,94,.7);background: rgba(34,197,94,.18)}
    .choice.wrong{border-color: rgba(239,68,68,.7);background: rgba(239,68,68,.18)}

    .resultBox{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
      padding:12px;
      position:relative;
    }
    .resultHd{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .resultMsg{font-weight:900}
    .resultSub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.45}
    .split{
      display:grid;
      grid-template-columns: 1fr 280px;
      gap:12px;
      margin-top:12px;
      align-items:start;
    }
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }

    svg.kvg{
      width:100%;
      height:auto;
      display:block;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.08), transparent 60%);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
    }
    .kvg path{
      fill:none;
      stroke: rgba(255,255,255,.88);
      stroke-width: 3.6;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .fadeIn{animation:fade .18s ease-out}
    @keyframes fade{from{opacity:.0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}

    footer{
      margin:16px 0 8px;
      color: var(--muted);
      font-size:12px;
      text-align:center;
      opacity:.9;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="topRow">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>ヴァンパイア全知全能</h1>
            <div class="sub">N5–N4</div>
          </div>
        </div>

        <div class="pillRow">
          <div class="pill"><span class="dot"></span><span id="totalPill">Total: — kanjis</span></div>
        </div>
      </div>

      <div class="tabs" role="tablist">
        <div class="tabBtn active" data-tab="kanji" role="tab">Kanjis</div>
        <div class="tabBtn" data-tab="game" role="tab">Jogo</div>
      </div>
    </header>

    <main>
      <!-- TAB: KANJI -->
      <section id="tab-kanji" class="grid2">
        <div class="card">
          <div class="cardHd">
            <h2>Detalhes</h2>
            <div class="controls">
              <button class="btn small" id="btnReplayStroke">Repetir stroke</button>
              <button class="btn small primary" id="btnPracticeThis">Praticar</button>
            </div>
          </div>
          <div class="cardBd">
            <div class="kHero">
              <div class="kBig" id="kBig">—</div>

              <div class="kMeta">
                <div class="kLine">
                  <span class="tag"><strong>Nível:</strong> <span id="kLvl">—</span></span>
                  <span class="tag"><strong>Kun:</strong> <span id="kKun">—</span></span>
                  <span class="tag"><strong>On:</strong> <span id="kOn">—</span></span>
                  <span class="tag"><strong>PT:</strong> <span id="kMean">—</span></span>
                </div>
                <div class="hint" id="kHint"></div>

                <ul class="list" id="kWords"></ul>
              </div>

              <div class="strokeBox">
                <div class="strokeTop">
                  <div class="mini">Stroke</div>
                  <div class="mini" id="strokeStatus">—</div>
                </div>
                <div id="strokeSvgWrap"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHd">
            <h2>Lista</h2>
            <div class="controls">
              <select class="select" id="filterLvl">
                <option value="ALL">N5+N4</option>
                <option value="N5">N5</option>
                <option value="N4">N4</option>
              </select>
              <input class="input" id="searchKanji" placeholder="Buscar kanji (ex: 学)" />
            </div>
          </div>
          <div class="cardBd">
            <div class="muted" id="countInfo">—</div>
            <div style="height:10px"></div>
            <div class="kGrid" id="kGrid"></div>
          </div>
        </div>
      </section>

      <!-- TAB: GAME -->
      <section id="tab-game" style="display:none">
        <div class="card">
          <div class="cardHd">
            <h2>Jogo</h2>
            <div class="controls">
              <select class="select" id="gameLvl">
                <option value="ALL">N5+N4</option>
                <option value="N5">N5</option>
                <option value="N4">N4</option>
              </select>
              <button class="btn good" id="btnStart">Começar</button>
              <button class="btn" id="btnNext" disabled>Próximo</button>
            </div>
          </div>

          <div class="cardBd">
            <div class="quizCard" id="quizBox">
              <div class="quizTop">
                <div class="score">
                  <div class="pill"><strong>Acertos:</strong> <span id="hit">0</span></div>
                  <div class="pill"><strong>Erros:</strong> <span id="miss">0</span></div>
                  <div class="pill"><strong>Streak:</strong> <span id="streak">0</span></div>
                </div>
                <div class="pill"><strong>Fase:</strong> <span id="phase">—</span></div>
              </div>

              <div class="qMain">
                <div class="qKanji" id="qKanji">—</div>
                <div class="qText">
                  <p class="qTitle" id="qTitle"></p>
                  <p class="qPrompt" id="qPrompt"></p>
                  <div class="choices" id="choices"></div>

                  <div class="resultBox" id="resultBox" style="display:none">
                    <div class="resultHd">
                      <div class="resultMsg" id="resultMsg">—</div>
                      <div class="controls">
                        <button class="btn small" id="btnReplayStroke2">Repetir stroke</button>
                      </div>
                    </div>
                    <div class="resultSub" id="resultSub">—</div>

                    <div class="split">
                      <div>
                        <ul class="list" id="gameWord"></ul>
                      </div>
                      <div class="strokeBox" style="width:auto">
                        <div class="strokeTop">
                          <div class="mini">Stroke</div>
                          <div class="mini" id="strokeStatus2">—</div>
                        </div>
                        <div id="strokeSvgWrap2"></div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

      <footer>ヴァンパイア全知全能</footer>
    </main>
  </div>

<script>
/* =========================
   LISTAS
========================= */
const N5 = "一 七 万 三 上 下 中 九 二 五 人 今 休 何 先 入 八 六 円 出 分 前 北 十 千 午 半 南 友 右 名 四 国 土 外 大 天 女 子 学 小 山 川 左 年 後 日 時 書 月 木 本 来 東 校 母 毎 気 水 火 父 生 男 白 百 聞 行 西 見 話 語 読 車 金 長 間 雨 電 食 高"
  .split(/\s+/).filter(Boolean);

const N4 = "不 世 主 事 京 仕 代 以 会 住 体 作 使 借 元 兄 公 写 冬 切 別 力 勉 動 医 去 口 古 台 同 味 品 員 問 図 地 堂 場 売 夏 夕 多 夜 妹 姉 始 字 安 室 家 少 屋 工 帰 広 店 度 建 弟 強 待 心 思 急 悪 意 手 持 教 文 料 新 方 旅 族 早 明 映 春 昼 曜 有 服 朝 業 楽 歌 止 正 歩 死 注 洋 海 漢 牛 物 特 犬 理 用 田 町 画 界 病 発 的 目 真 着 知 研 社 私 秋 究 空 立 答 紙 終 習 考 者 肉 自 色 花 英 茶 親 言 計 試 買 貸 質 赤 走 起 足 転 近 送 通 週 運 道 重 野 銀 開 院 集 青 音 題 風 飯 飲 館 駅 験 魚 鳥 黒"
  .split(/\s+/).filter(Boolean);

const ALL = [...new Set([...N5, ...N4])];
const LEVEL_OF = Object.fromEntries([
  ...N5.map(k => [k,"N5"]),
  ...N4.map(k => [k,"N4"]),
]);

/* =========================
   SIGNIFICADO PT (N4 + N5)
   (significado “fixo” pra não ficar errado/variável)
========================= */
const PT_MEAN = {
  // N5
  "一":"um","七":"sete","万":"dez mil","三":"três","上":"cima","下":"baixo","中":"meio","九":"nove","二":"dois","五":"cinco",
  "人":"pessoa","今":"agora","休":"descansar; folga","何":"o que","先":"antes; ponta","入":"entrar","八":"oito","六":"seis","円":"iene; círculo",
  "出":"sair; tirar","分":"minuto; parte","前":"antes; frente","北":"norte","十":"dez","千":"mil","午":"meio-dia","半":"metade","南":"sul",
  "友":"amigo","右":"direita","名":"nome","四":"quatro","国":"país","土":"terra","外":"fora","大":"grande","天":"céu","女":"mulher","子":"criança",
  "学":"estudo; aprender","小":"pequeno","山":"montanha","川":"rio","左":"esquerda","年":"ano","後":"depois","日":"dia","時":"hora","書":"escrever",
  "月":"mês; lua","木":"árvore","本":"livro; origem","来":"vir","東":"leste","校":"escola","母":"mãe","毎":"cada; todo","気":"energia; ar",
  "水":"água","火":"fogo","父":"pai","生":"vida; nascer","男":"homem","白":"branco","百":"cem","聞":"ouvir; perguntar","行":"ir","西":"oeste",
  "見":"ver","話":"falar","語":"língua; palavra","読":"ler","車":"carro","金":"dinheiro; ouro","長":"longo; chefe","間":"intervalo; entre",
  "雨":"chuva","電":"eletricidade","食":"comer","高":"alto; caro",
  // N4
  "不":"não; negativo","世":"mundo; geração","主":"principal; dono","事":"coisa; assunto","京":"capital","仕":"servir; trabalho",
  "代":"substituição; era","以":"a partir de","会":"reunião; encontro","住":"morar","体":"corpo","作":"fazer; criar","使":"usar",
  "借":"pegar emprestado","元":"origem; ex-","兄":"irmão mais velho","公":"público","写":"copiar; fotografar","冬":"inverno","切":"cortar",
  "別":"separar; diferente","力":"força","勉":"esforço","動":"mover","医":"médico; medicina","去":"ir embora; passado","口":"boca",
  "古":"velho","台":"plataforma; suporte","同":"mesmo","味":"sabor","品":"produto; qualidade","員":"membro; funcionário","問":"perguntar; problema",
  "図":"mapa; desenho","地":"terra; chão","堂":"salão; templo","場":"lugar","売":"vender","夏":"verão","夕":"entardecer","多":"muito",
  "夜":"noite","妹":"irmã mais nova","姉":"irmã mais velha","始":"começar","字":"letra; caractere","安":"barato; seguro","室":"sala",
  "家":"casa; família","少":"pouco","屋":"loja; vendedor","工":"construção; artesanato","帰":"voltar","広":"amplo; largo","店":"loja",
  "度":"grau; vez","建":"construir","弟":"irmão mais novo","強":"forte","待":"esperar","心":"coração; mente","思":"pensar","急":"urgente; apressar",
  "悪":"mau","意":"intenção; ideia","手":"mão","持":"segurar; ter","教":"ensinar","文":"texto; frase","料":"taxa; material","新":"novo",
  "方":"direção; jeito","旅":"viagem","族":"família; grupo","早":"cedo; rápido","明":"claro; amanhã","映":"refletir; projetar","春":"primavera",
  "昼":"dia; meio-dia","曜":"dia da semana","有":"ter; existir","服":"roupa","朝":"manhã","業":"trabalho; indústria","楽":"prazer; música",
  "歌":"canção","止":"parar","正":"correto","歩":"andar; passo","死":"morrer","注":"atenção","洋":"ocidental","海":"mar","漢":"chinês",
  "牛":"boi; vaca","物":"coisa; objeto","特":"especial","犬":"cachorro","理":"razão; lógica","用":"uso","田":"arrozal","町":"cidade; bairro",
  "画":"quadro; desenho","界":"mundo; limite","病":"doença","発":"partir; emitir","的":"-al; alvo","目":"olho","真":"verdadeiro",
  "着":"vestir; chegar","知":"saber; conhecer","研":"pesquisar","社":"empresa; sociedade","私":"eu; privado","秋":"outono","究":"pesquisa profunda",
  "空":"céu; vazio","立":"levantar; ficar em pé","答":"resposta","紙":"papel","終":"terminar","習":"aprender; praticar","考":"pensar","者":"pessoa",
  "肉":"carne","自":"si mesmo","色":"cor","花":"flor","英":"inglês","茶":"chá","親":"pais; íntimo","言":"dizer; palavra",
  "計":"medir; plano","試":"testar","買":"comprar","貸":"emprestar (dar)","質":"qualidade; matéria","赤":"vermelho","走":"correr",
  "起":"acordar; levantar","足":"pé; suficiente","転":"virar; cair","近":"perto","送":"enviar","通":"passar; frequentar",
  "週":"semana","運":"sorte; transportar","道":"caminho","重":"pesado","野":"campo","銀":"prata","開":"abrir","院":"instituto; hospital",
  "集":"reunir","青":"azul/verde","音":"som","題":"tema","風":"vento; estilo","飯":"refeição; arroz","飲":"beber","館":"prédio; salão",
  "駅":"estação","験":"experiência; teste","魚":"peixe","鳥":"pássaro","黒":"preto"
};

/* =========================
   APIs
========================= */
const KANJI_API = "https://kanjiapi.dev/v1/kanji/";
const JOTOBA_WORDS = "https://jotoba.de/api/search/words?query=";
const KVG_BASE = "https://cdn.jsdelivr.net/npm/kanjivg@1.6.1/kanji/";

/* =========================
   HELPERS
========================= */
const $ = (s, el=document) => el.querySelector(s);
const $$ = (s, el=document) => [...el.querySelectorAll(s)];
const uniq = (arr)=>[...new Set(arr)];
function shuffle(a){
  const x=[...a];
  for(let i=x.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [x[i],x[j]]=[x[j],x[i]];
  }
  return x;
}
function toHiragana(kana){
  return (kana||"").replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
}
function unicodeHex5(ch){
  return ch.codePointAt(0).toString(16).padStart(5,"0");
}

/* =========================
   CACHE
========================= */
const cacheKanji = new Map(); // kanji -> kanjiapi json
const cacheSvg = new Map();   // kanji -> svgText
const cacheWord1 = new Map(); // kanji -> {jp,kana,gloss}

async function getKanjiInfo(kanji){
  if(cacheKanji.has(kanji)) return cacheKanji.get(kanji);
  const res = await fetch(KANJI_API + encodeURIComponent(kanji));
  if(!res.ok) throw new Error("kanjiapi fail");
  const json = await res.json();
  cacheKanji.set(kanji,json);
  return json;
}

async function getKanjiVG(kanji){
  if(cacheSvg.has(kanji)) return cacheSvg.get(kanji);
  const url = KVG_BASE + unicodeHex5(kanji) + ".svg";
  const res = await fetch(url);
  if(!res.ok) throw new Error("kvg fail");
  const svgText = await res.text();
  cacheSvg.set(kanji, svgText);
  return svgText;
}

// 1 palavra (jogo). Se não vier, retorna null.
async function getOneWord(kanji){
  if(cacheWord1.has(kanji)) return cacheWord1.get(kanji);

  try{
    const res = await fetch(JOTOBA_WORDS + encodeURIComponent(kanji),{
      headers:{ "Accept-Language":"pt-BR,pt;q=0.9,en;q=0.4" }
    });
    if(!res.ok) throw new Error("jotoba fail");
    const json = await res.json();
    const items = Array.isArray(json) ? json : (json?.data ?? json?.results ?? []);

    for(const it of items){
      if(!it?.reading) continue;
      const jp = it.reading.kanji || it.reading.kana || "";
      if(!jp.includes(kanji)) continue;

      const senses = Array.isArray(it.senses) ? it.senses : [];
      let sense = senses.find(s => (s.language||"").toLowerCase().includes("portuguese") || (s.language||"").toLowerCase().includes("pt"));
      if(!sense) sense = senses.find(s => (s.language||"").toLowerCase().includes("english"));
      if(!sense) sense = senses[0];

      const gloss = (sense?.glosses || []).slice(0,2).join("; ") || "—";
      const out = { jp, kana: it.reading.kana || "—", gloss };
      cacheWord1.set(kanji, out);
      return out;
    }
  }catch(e){}

  cacheWord1.set(kanji, null);
  return null;
}

/* =========================
   STROKE ANIMATION
========================= */
function mountAndAnimateSVG(svgWrap, svgText, statusEl){
  svgWrap.innerHTML = "";
  statusEl.textContent = "…";

  const tmp = document.createElement("div");
  tmp.innerHTML = svgText;

  const svg = tmp.querySelector("svg");
  if(!svg){
    statusEl.textContent = "—";
    return;
  }

  svg.classList.add("kvg");
  if(!svg.getAttribute("viewBox")) svg.setAttribute("viewBox","0 0 109 109");

  const paths = [...svg.querySelectorAll("path")];
  if(!paths.length){
    statusEl.textContent = "—";
    svgWrap.appendChild(svg);
    return;
  }

  paths.forEach((p,i)=>{
    let len = 160;
    try{ len = p.getTotalLength(); }catch{}
    p.style.strokeDasharray = String(len);
    p.style.strokeDashoffset = String(len);
    p.style.opacity = "1";
    p.style.transition = "none";
  });

  svgWrap.appendChild(svg);
  statusEl.textContent = `${paths.length}`;

  const base = 260;
  const gap = 70;

  requestAnimationFrame(()=>{
    paths.forEach((p,i)=>{
      const delay = i*(base+gap);
      p.style.transition = `stroke-dashoffset ${base}ms ease-out ${delay}ms`;
      p.style.strokeDashoffset = "0";
    });
  });
}

/* =========================
   TABS
========================= */
const tabBtns = $$(".tabBtn");
tabBtns.forEach(b=>{
  b.addEventListener("click", ()=>{
    tabBtns.forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    const t = b.dataset.tab;
    $("#tab-kanji").style.display = (t==="kanji") ? "" : "none";
    $("#tab-game").style.display  = (t==="game") ? "" : "none";
    window.scrollTo({top:0,behavior:"smooth"});
  });
});

/* =========================
   KANJI TAB
========================= */
const kGrid = $("#kGrid");
const searchKanji = $("#searchKanji");
const filterLvl = $("#filterLvl");

let currentKanji = null;

function visibleList(){
  const lvl = filterLvl.value;
  const q = (searchKanji.value||"").trim();
  let base = ALL;
  if(lvl!=="ALL") base = base.filter(k => LEVEL_OF[k]===lvl);
  if(q) base = base.filter(k => k.includes(q));
  return base;
}

function renderGrid(){
  const list = visibleList();
  $("#countInfo").textContent = `${list.length} / ${ALL.length}`;
  kGrid.innerHTML = "";
  for(const k of list){
    const btn = document.createElement("button");
    btn.className = "kBtn";
    btn.textContent = k;
    if(k===currentKanji) btn.classList.add("active");
    btn.addEventListener("click", ()=>selectKanji(k,true));
    kGrid.appendChild(btn);
  }
}

async function selectKanji(kanji, scrollTop){
  currentKanji = kanji;
  renderGrid();

  $("#kBig").textContent = kanji;
  $("#kLvl").textContent = LEVEL_OF[kanji] || "—";
  $("#kKun").textContent = "—";
  $("#kOn").textContent = "—";
  $("#kMean").textContent = PT_MEAN[kanji] || "—";
  $("#kHint").textContent = "";
  $("#kWords").innerHTML = "";
  $("#strokeSvgWrap").innerHTML = "";
  $("#strokeStatus").textContent = "…";

  if(scrollTop) window.scrollTo({top:0,behavior:"smooth"});

  // leituras sempre do kanjiapi (corrige “alguns errados”)
  try{
    const info = await getKanjiInfo(kanji);
    const kun = (info.kun_readings||[]).slice(0,6);
    const on  = (info.on_readings||[]).map(toHiragana).slice(0,6);
    $("#kKun").textContent = kun.length ? kun.join(" / ") : "—";
    $("#kOn").textContent  = on.length  ? on.join(" / ") : "—";

    // se PT não existir, cai no meanings[0] (inglês)
    if(!PT_MEAN[kanji]){
      $("#kMean").textContent = (info.meanings && info.meanings[0]) ? info.meanings[0] : "—";
    }
  }catch{}

  // (opcional) lista vazia (sem textos desnecessários)
  $("#kWords").innerHTML = "";

  // stroke
  try{
    const svgText = await getKanjiVG(kanji);
    mountAndAnimateSVG($("#strokeSvgWrap"), svgText, $("#strokeStatus"));
  }catch{
    $("#strokeStatus").textContent = "—";
    $("#strokeSvgWrap").innerHTML = "";
  }
}

searchKanji.addEventListener("input", renderGrid);
filterLvl.addEventListener("change", renderGrid);

$("#btnReplayStroke").addEventListener("click", async ()=>{
  if(!currentKanji) return;
  try{
    const svgText = await getKanjiVG(currentKanji);
    mountAndAnimateSVG($("#strokeSvgWrap"), svgText, $("#strokeStatus"));
  }catch{}
});

$("#btnPracticeThis").addEventListener("click", ()=>{
  if(!currentKanji) return;
  tabBtns.find(b=>b.dataset.tab==="game").click();
  startGame({forceList:[currentKanji]});
});

/* =========================
   GAME
========================= */
let game = {
  running:false,
  pool:[],
  forceList:null,

  k:null,
  info:null,
  word:null,

  stage:0, // 0 leitura, 1 significado, 2 resultado
  hit:0, miss:0, streak:0,

  svgText:null
};

function setMood(ok){
  document.body.style.background =
    `radial-gradient(1200px 600px at 15% -10%, rgba(124,58,237,.35), transparent 55%),
     radial-gradient(900px 600px at 85% 0%, ${ok ? "rgba(34,197,94,.22)" : "rgba(239,68,68,.18)"}, transparent 60%),
     radial-gradient(1100px 700px at 50% 120%, rgba(239,68,68,.10), transparent 55%),
     linear-gradient(180deg, var(--bg0), var(--bg1))`;
}
function updateScoreUI(){
  $("#hit").textContent = game.hit;
  $("#miss").textContent = game.miss;
  $("#streak").textContent = game.streak;
}
function setPhaseLabel(){
  $("#phase").textContent = game.stage===0 ? "Leitura" : (game.stage===1 ? "Significado" : "Resultado");
}
function shufflePick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function makeChoices(correct, all, n=4){
  const pool = shuffle(all.filter(x=>x && x!==correct)).slice(0, n-1);
  return shuffle([correct, ...pool]);
}
function lockChoices(){ $$("#choices .choice").forEach(b=>b.classList.add("locked")); }
function showResult(show){ $("#resultBox").style.display = show ? "" : "none"; }

function quizReading(info){
  // ON primeiro; se não tiver, KUN primeiro
  const on0 = info?.on_readings?.[0];
  if(on0) return toHiragana(on0);
  const kun0 = info?.kun_readings?.[0];
  if(kun0) return kun0;
  return "—";
}

async function loadRound(kanji){
  game.k = kanji;
  game.stage = 0;
  game.info = null;
  game.word = null;
  game.svgText = null;

  $("#qKanji").textContent = kanji;
  $("#qTitle").textContent = "Leitura";
  $("#qPrompt").textContent = "";
  $("#choices").innerHTML = "";
  showResult(false);
  $("#btnNext").disabled = true;

  // data
  try{ game.info = await getKanjiInfo(kanji); }catch{ game.info = null; }
  const read = game.info ? quizReading(game.info) : "—";
  const mean = PT_MEAN[kanji] || (game.info?.meanings?.[0] || "—");

  // stroke
  $("#strokeSvgWrap2").innerHTML = "";
  $("#strokeStatus2").textContent = "…";
  try{
    game.svgText = await getKanjiVG(kanji);
    mountAndAnimateSVG($("#strokeSvgWrap2"), game.svgText, $("#strokeStatus2"));
  }catch{
    $("#strokeStatus2").textContent = "—";
    $("#strokeSvgWrap2").innerHTML = "";
  }

  // 1 palavra
  game.word = await getOneWord(kanji);

  // montar leitura
  const distract = [];
  const others = shuffle(game.pool.filter(k=>k!==kanji)).slice(0, 18);
  for(const okk of others){
    try{
      const inf = await getKanjiInfo(okk);
      const r = quizReading(inf);
      if(r && r!=="—") distract.push(r);
      if(distract.length>=10) break;
    }catch{}
  }

  const opts = makeChoices(read, uniq([read, ...distract]), 4);
  renderChoices(opts, read, (chosen, correct, btn)=>answerReading(chosen, correct, btn, read, mean));
}

function renderChoices(options, correct, handler){
  $("#choices").innerHTML = "";
  options.forEach(opt=>{
    const b = document.createElement("button");
    b.className = "choice";
    b.innerHTML = `<div style="font-size:16px">${opt}</div>`;
    b.addEventListener("click", ()=>handler(opt, correct, b));
    $("#choices").appendChild(b);
  });
}

function answerReading(chosen, correct, btn, read, mean){
  if(game.stage!==0) return;
  lockChoices();

  const ok = chosen===correct;
  if(ok){
    setMood(true);
    btn.classList.add("correct");
    game.stage = 1;
    setPhaseLabel();

    $("#qTitle").textContent = "Significado";
    $("#qPrompt").textContent = "";

    const distract = [];
    const others = shuffle(game.pool.filter(k=>k!==game.k)).slice(0, 24);
    for(const k of others){
      const m = PT_MEAN[k];
      if(m) distract.push(m);
      if(distract.length>=10) break;
    }
    const opts = makeChoices(mean, uniq([mean, ...distract]), 4);
    renderChoices(opts, mean, (chosen2, correct2, btn2)=>answerMeaning(chosen2, correct2, btn2, read, mean));
  }else{
    setMood(false);
    btn.classList.add("wrong");
    $$("#choices .choice").forEach(b=>{
      if(b.textContent.trim()===correct) b.classList.add("correct");
    });
    finish(false, read, mean);
  }
}

function answerMeaning(chosen, correct, btn, read, mean){
  if(game.stage!==1) return;
  lockChoices();

  const ok = chosen===correct;
  if(ok){
    setMood(true);
    btn.classList.add("correct");
    finish(true, read, mean);
  }else{
    setMood(false);
    btn.classList.add("wrong");
    $$("#choices .choice").forEach(b=>{
      if(b.textContent.trim()===correct) b.classList.add("correct");
    });
    finish(false, read, mean);
  }
}

function finish(ok, read, mean){
  game.stage = 2;
  setPhaseLabel();

  if(ok){
    game.hit += 1;
    game.streak += 1;
    $("#resultMsg").textContent = "✅";
  }else{
    game.miss += 1;
    game.streak = 0;
    $("#resultMsg").textContent = "❌";
  }
  updateScoreUI();

  $("#resultSub").innerHTML = `
    <div><span class="muted">Leitura:</span> <strong>${read}</strong></div>
    <div><span class="muted">PT:</span> <strong>${mean}</strong></div>
  `;

  // 1 palavra (sem texto extra)
  const ul = $("#gameWord");
  ul.innerHTML = "";
  if(game.word){
    const li = document.createElement("li");
    li.className = "li fadeIn";
    li.innerHTML = `
      <div class="liTop">
        <div class="jp">${game.word.jp}</div>
        <div class="fur">${game.word.kana}</div>
      </div>
      <div class="gloss">${game.word.gloss}</div>
    `;
    ul.appendChild(li);
  }else{
    const li = document.createElement("li");
    li.className = "li";
    li.innerHTML = `<div class="muted">—</div>`;
    ul.appendChild(li);
  }

  showResult(true);
  $("#btnNext").disabled = false;
}

function buildPool(){
  const lvl = $("#gameLvl").value;
  let p = ALL;
  if(lvl!=="ALL") p = p.filter(k => LEVEL_OF[k]===lvl);
  return p;
}

async function startGame(opts={}){
  game.running = true;
  game.forceList = opts.forceList || null;
  game.pool = game.forceList ? [...game.forceList] : buildPool();

  $("#btnNext").disabled = true;
  showResult(false);
  game.hit=0; game.miss=0; game.streak=0;
  updateScoreUI();

  await nextRound();
}

async function nextRound(){
  $("#btnNext").disabled = true;
  showResult(false);

  const k = shufflePick(game.pool);
  await loadRound(k);
}

$("#btnStart").addEventListener("click", ()=>startGame());
$("#btnNext").addEventListener("click", ()=>nextRound());

$("#btnReplayStroke2").addEventListener("click", async ()=>{
  if(!game.k || !game.svgText) return;
  mountAndAnimateSVG($("#strokeSvgWrap2"), game.svgText, $("#strokeStatus2"));
});

/* =========================
   INIT
========================= */
$("#totalPill").textContent = `Total: ${ALL.length} kanjis`;
renderGrid();
selectKanji(ALL[0], false).catch(()=>{});
</script>
</body>
</html>
